"use strict";(self.webpackChunkcellscope_lab=self.webpackChunkcellscope_lab||[]).push([[509],{509:(e,t,s)=>{s.r(t),s.d(t,{default:()=>u});var n=s(794),i=s(722),l=s(23),a=s(296),o=s(262),r=s(256);const c="cellscope:open-list",d="cellscope:open-graph",h=e=>{const t=e.replace(/\\/g,"/").split("/");return t[t.length-1]||e};class p extends r.Widget{constructor(e,t){super(),this.app=e,this.tracker=t,this._statusNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-status",e})(),this._pendingNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-pending",e.style.display="none",e})(),this._filterNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-filters",e.style.display="none",e})(),this._resultsNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-results",e.style.paddingBottom="8px",e})(),this._edgesNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-edges",e.style.marginTop="12px",e})(),this._contentNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-content",e.style.flex="1 1 auto",e.style.overflowY="auto",e.style.paddingRight="4px",e.appendChild(this._resultsNode),e.appendChild(this._edgesNode),e})(),this._exportNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-export",e})(),this._helpNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-help",e.innerHTML="Need the graph? Export a crate, then run <code>CellScope: Open Graph Panel</code>.",e})(),this._latestGraphUrl=null,this._lastAnalysis=null,this._lastReview=null,this._storedHints=null,this._activeNotebookPath=null,this._filterState=this._createDefaultFilterState(),this._kernelOptions=[],this._edgeViaOptions=[],this._roleOptions=[],this._fileHintOptions=[],this._pendingTimeout=null,this._pendingChanges=!1,this._notebookListeners=[],this._observedPanel=null,this._kernelWasBusySinceLastIdle=!1,this._analyzeInFlight=!1,this._rerunAfterCurrent=!1,this._lastFilterSignature="",this.id="cellscope-analysis-panel",this.title.label="CellScope",this.title.closable=!0,this.addClass("jp-CellScopePanel"),this.node.style.display="flex",this.node.style.flexDirection="column",this.node.style.height="100%",this._settings=this.app.serviceManager.serverSettings,this.node.appendChild(this._buildHeader()),this.node.appendChild(this._statusNode),this.node.appendChild(this._pendingNode),this.node.appendChild(this._filterNode),this.node.appendChild(this._contentNode),this.node.appendChild(this._exportNode),this.node.appendChild(this._helpNode),this.tracker&&(this.tracker.currentChanged.connect(this._syncNotebook,this),this.tracker.widgetAdded.connect(this._syncNotebook,this)),this._syncNotebook()}dispose(){this.tracker&&(this.tracker.currentChanged.disconnect(this._syncNotebook,this),this.tracker.widgetAdded.disconnect(this._syncNotebook,this)),this._disposeNotebookListeners(),this._cancelPendingTimer(),super.dispose()}openGraphView(){if(!this._latestGraphUrl)return this._setStatus("Run an export before opening the graph viewer.","warn"),!1;const e=document.createElement("iframe");e.src=this._latestGraphUrl,e.style.width="100%",e.style.height="100%",e.style.border="none";const t=new r.Widget({node:document.createElement("div")});t.node.style.height="100%",t.node.appendChild(e);const s=new n.MainAreaWidget({content:t});return s.title.label="CellScope Graph",s.title.closable=!0,this.app.shell.add(s,"main"),this.app.shell.activateById(s.id),!0}_buildHeader(){const e=document.createElement("div");e.className="jp-CellScopePanel-header";const t=document.createElement("h3");t.textContent="CellScope Analyzer",e.appendChild(t);const s=document.createElement("div");s.className="jp-CellScopePanel-row";const n=document.createElement("span");n.textContent="Notebook: ",s.appendChild(n),this._pathNode=document.createElement("code"),this._pathNode.textContent="(no notebook)",s.appendChild(this._pathNode),e.appendChild(s);const i=document.createElement("div");return i.className="jp-CellScopePanel-controls",this._analyzeBtn=document.createElement("button"),this._analyzeBtn.textContent="Analyze",this._analyzeBtn.className="jp-mod-styled",this._analyzeBtn.addEventListener("click",()=>{this._analyze()}),this._exportBtn=document.createElement("button"),this._exportBtn.textContent="Export Crate",this._exportBtn.className="jp-mod-styled",this._exportBtn.addEventListener("click",()=>{this._export()}),this._graphBtn=document.createElement("button"),this._graphBtn.textContent="Open Graph",this._graphBtn.className="jp-mod-styled",this._graphBtn.disabled=!0,this._graphBtn.addEventListener("click",()=>{this.openGraphView()||this._setStatus("Export a crate before opening the graph viewer.","warn")}),i.appendChild(this._analyzeBtn),i.appendChild(this._exportBtn),i.appendChild(this._graphBtn),e.appendChild(i),e}async _analyze(){await this._runAnalysis("manual")}async _export(){const e=this._currentNotebookPath();if(e){this._setBusy(!0,"Preparing review…");try{const t=await this._requestAnalysis(e);this._renderAnalysis(t),this._setBusy(!1);const s=await this._showReviewDialog(t.graph);if(!s)return void this._setStatus("Export cancelled.","warn");this._setBusy(!0,"Exporting RO-Crate…");const n=`out-lab/${Date.now()}`,i=l.URLExt.join(this._settings.baseUrl,"cellscope","export"),o=await a.ServerConnection.makeRequest(i,{method:"POST",body:JSON.stringify({notebook:e,out_dir:n,hints:s.hints}),headers:{"Content-Type":"application/json"}},this._settings);if(!o.ok)throw new a.ServerConnection.ResponseError(o);const r=await o.json(),c=r.crate;this._latestGraphUrl=this._buildGraphUrl(c),this._renderExportSummary(c,r.index??null),this._lastReview=s,this._graphBtn.disabled=!this._latestGraphUrl,this._lastAnalysis?(this._syncFilterOptions(this._lastAnalysis),this._renderFilterControls(),this._saveFilterState(),this._renderFilteredView(!0)):this._renderFilteredView(!0),this._setStatus("Export complete.","info")}catch(e){console.error(e),this._setStatus(`Failed to export crate: ${this._stringifyError(e)}`,"error")}finally{this._setBusy(!1)}}else this._setStatus("Open a notebook to export.","warn")}_renderExportSummary(e,t){const s=[];if(s.push(`Crate written to ${this._normalisePath(e)}`),t){const e="string"==typeof t.endpoint?t.endpoint:null,n="string"==typeof t.output?t.output:null,i="number"==typeof t.triples?t.triples:null,l="number"==typeof t.attempts?t.attempts:null,a="number"==typeof t.duration_seconds?t.duration_seconds:null,o="number"==typeof t.status?t.status:null;if(e){const t=l?`attempts ${l}`:"attempts n/a",n=null!==a?`in ${a.toFixed(1)}s`:"",r=null!==o?`status ${o}`:"status n/a",c=null!==i?`${i} triples`:"triples n/a";s.push(`SPARQL push → ${e} (${c}, ${r}, ${t} ${n}).`)}else{const e=n??"index/last_update.sparql",t=null!==i?`${i} triples`:"triples n/a";s.push(`SPARQL delta saved to ${this._normalisePath(e)} (${t}, endpoint not configured).`)}}this._exportNode.textContent=s.join(" • ")}_normalisePath(e){return e?e.replace(/\\/g,"/"):e}async _runAnalysis(e){const t=this._currentNotebookPath();if(t)if(this._analyzeInFlight)"auto"===e&&(this._rerunAfterCurrent=!0,this._cancelPendingTimer());else{null!==this._pendingTimeout&&(window.clearTimeout(this._pendingTimeout),this._pendingTimeout=null),this._analyzeInFlight=!0,this._rerunAfterCurrent=!1,"manual"===e?this._setBusy(!0,"Analyzing notebook…"):this._setBusy(!0,void 0,!0);try{const s=await this._requestAnalysis(t);this._renderAnalysis(s),"manual"===e?this._setStatus("Analysis complete.","info"):(this._statusNode.textContent??"").trim()||this._setStatus("Analysis refreshed.","info")}catch(e){console.error(e),this._setStatus(`Failed to analyze notebook: ${this._stringifyError(e)}`,"error")}finally{this._analyzeInFlight=!1,this._setBusy(!1,void 0,"auto"===e),this._rerunAfterCurrent?(this._setPending(!0,"Additional notebook changes detected. Refreshing analysis…"),this._scheduleAutoAnalyze("content"),this._rerunAfterCurrent=!1):this._setPending(!1)}}else"manual"===e&&this._setStatus("Open a notebook to analyze.","warn")}_renderAnalysis(e){this._lastAnalysis=e.graph,this._syncFilterOptions(e.graph),this._renderFilterControls(),this._saveFilterState(),this._renderFilteredView(!0)}_handleNotebookChange(e){if(!this._lastAnalysis||!this._activeNotebookPath)return;let t;switch(e){case"save":t="Notebook saved. Refreshing analysis…";break;case"execution":t="Execution finished. Refreshing analysis…";break;default:t="Notebook changed. Refreshing analysis…"}this._setPending(!0,t),this._scheduleAutoAnalyze(e)}_scheduleAutoAnalyze(e){if(!this._lastAnalysis||!this._activeNotebookPath)return;null!==this._pendingTimeout&&window.clearTimeout(this._pendingTimeout);const t="save"===e?400:"execution"===e?800:1e3,s=this._activeNotebookPath;this._pendingTimeout=window.setTimeout(()=>{this._pendingTimeout=null,s===this._activeNotebookPath&&this._runAnalysis("auto")},t)}_setPending(e,t,s=!1){if(e)return this._pendingChanges=!0,this._pendingNode.style.display="",this._pendingNode.classList.toggle("jp-mod-warn",!0),void(this._pendingNode.textContent=t??"Notebook changes detected. Analysis will refresh shortly…");(s||null===this._pendingTimeout&&!this._rerunAfterCurrent)&&(this._pendingChanges=!1,this._pendingNode.style.display="none",this._pendingNode.classList.remove("jp-mod-warn"),this._pendingNode.textContent="")}_cancelPendingTimer(){null!==this._pendingTimeout&&(window.clearTimeout(this._pendingTimeout),this._pendingTimeout=null)}_setupNotebookListeners(e){if(this._disposeNotebookListeners(),this._observedPanel=e,this._kernelWasBusySinceLastIdle=!1,this._cancelPendingTimer(),!e)return void this._setPending(!1,void 0,!0);const{context:t}=e;if(!t)return;const s=(e,t)=>{"completed"===t&&this._handleNotebookChange("save")};t.saveState.connect(s,this),this._notebookListeners.push(()=>t.saveState.disconnect(s,this));const n=t.sessionContext;if(n){const e=(e,t)=>{this._onKernelStatusChanged(t)};n.statusChanged.connect(e,this),this._notebookListeners.push(()=>n.statusChanged.disconnect(e,this))}}_disposeNotebookListeners(){for(;this._notebookListeners.length;){const e=this._notebookListeners.pop();try{e?.()}catch(e){console.debug("[cellscope] Failed to detach notebook listener",e)}}this._observedPanel=null,this._kernelWasBusySinceLastIdle=!1}_onKernelStatusChanged(e){if(this._lastAnalysis&&this._activeNotebookPath){if("busy"!==e)return"idle"===e&&this._kernelWasBusySinceLastIdle?(this._kernelWasBusySinceLastIdle=!1,void this._handleNotebookChange("execution")):void("restarting"!==e&&"dead"!==e&&"terminating"!==e||(this._kernelWasBusySinceLastIdle=!1));this._kernelWasBusySinceLastIdle=!0}}_syncFilterOptions(e){this._kernelOptions=Array.from(new Set(e.cells.map(e=>e.kernel))).sort((e,t)=>e.localeCompare(t)),this._filterState.kernels=this._sanitizeFacet(this._filterState.kernels,this._kernelOptions);const t=new Set;e.edges.forEach(e=>{e.via&&t.add(String(e.via))}),0===t.size&&t.add("ast"),this._edgeViaOptions=Array.from(t).sort((e,t)=>e.localeCompare(t)),this._filterState.edgeVia=this._sanitizeFacet(this._filterState.edgeVia,this._edgeViaOptions);const s=this._effectiveHints(),n=new Set;s?.roles&&Object.values(s.roles).forEach(e=>{e&&n.add(String(e))}),this._roleOptions=Array.from(n).sort((e,t)=>e.localeCompare(t)),this._filterState.roles=this._sanitizeFacet(this._filterState.roles,this._roleOptions);const i=new Set;s?.domains&&Object.entries(s.domains).forEach(([e,t])=>{t&&Object.entries(t).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>i.add(`${e}: ${t}`)):null!=t&&i.add(`${e}: ${t}`)})}),this._fileHintOptions=Array.from(i).sort((e,t)=>e.localeCompare(t)),this._filterState.fileHints=this._sanitizeFacet(this._filterState.fileHints,this._fileHintOptions)}_renderFilterControls(){const e=this._lastAnalysis;if(this._filterNode.innerHTML="",!e)return void(this._filterNode.style.display="none");this._filterNode.style.display="";const t=document.createElement("div");t.className="jp-CellScopeFilters-search";const s=document.createElement("label");s.textContent="Search";const n=document.createElement("input");if(n.type="search",n.placeholder="Search cells, files, variables…",n.value=this._filterState.search,n.addEventListener("input",()=>{this._updateFilters(()=>{this._filterState.search=n.value})}),t.append(s,n),this._filterNode.appendChild(t),this._kernelOptions.length>1){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="Kernel",e.appendChild(t),this._kernelOptions.forEach(t=>{const s=document.createElement("label"),n=document.createElement("input");n.type="checkbox";const i=this._filterState.kernels,l=this._facetIsAll(i,this._kernelOptions)||!!i&&i.has(t);n.checked=l,n.addEventListener("change",()=>{this._updateFilters(()=>{this._filterState.kernels=this._toggleFacet(this._filterState.kernels,t,n.checked,this._kernelOptions)})}),s.append(n,document.createTextNode(t)),e.appendChild(s)}),this._filterNode.appendChild(e)}const i=document.createElement("div");if(i.className="jp-CellScopeFilters-toggleGroup",i.appendChild(this._createToggle("Only cells that write files",this._filterState.requireFileWrites,e=>this._updateFilters(()=>{this._filterState.requireFileWrites=e}))),i.appendChild(this._createToggle("Only cells that read files",this._filterState.requireFileReads,e=>this._updateFilters(()=>{this._filterState.requireFileReads=e}))),i.appendChild(this._createToggle("Only SoS exchanges",this._filterState.requireSos,e=>this._updateFilters(()=>{this._filterState.requireSos=e}))),this._filterNode.appendChild(i),this._roleOptions.length){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="Roles",e.appendChild(t),this._roleOptions.forEach(t=>{const s=document.createElement("label"),n=document.createElement("input");n.type="checkbox";const i=this._filterState.roles,l=this._facetIsAll(i,this._roleOptions)||!!i&&i.has(t);n.checked=l,n.addEventListener("change",()=>{this._updateFilters(()=>{this._filterState.roles=this._toggleFacet(this._filterState.roles,t,n.checked,this._roleOptions)})}),s.append(n,document.createTextNode(t)),e.appendChild(s)}),this._filterNode.appendChild(e)}if(this._fileHintOptions.length){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="File metadata",e.appendChild(t),this._fileHintOptions.forEach(t=>{const s=document.createElement("label"),n=document.createElement("input");n.type="checkbox";const i=this._filterState.fileHints,l=this._facetIsAll(i,this._fileHintOptions)||!!i&&i.has(t);n.checked=l,n.addEventListener("change",()=>{this._updateFilters(()=>{this._filterState.fileHints=this._toggleFacet(this._filterState.fileHints,t,n.checked,this._fileHintOptions)})}),s.append(n,document.createTextNode(t)),e.appendChild(s)}),this._filterNode.appendChild(e)}if(this._edgeViaOptions.length>1){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="Edge via",e.appendChild(t),this._edgeViaOptions.forEach(t=>{const s=document.createElement("label"),n=document.createElement("input");n.type="checkbox";const i=this._filterState.edgeVia,l=this._facetIsAll(i,this._edgeViaOptions)||!!i&&i.has(t);n.checked=l,n.addEventListener("change",()=>{this._updateFilters(()=>{this._filterState.edgeVia=this._toggleFacet(this._filterState.edgeVia,t,n.checked,this._edgeViaOptions)})}),s.append(n,document.createTextNode(t)),e.appendChild(s)}),this._filterNode.appendChild(e)}}_renderFilteredView(e=!1){const t=this._lastAnalysis;if(this._resultsNode.innerHTML="",this._edgesNode.innerHTML="",!t)return void(this._resultsNode.textContent="Run Analyze to see notebook metadata.");const s=t.cells.filter(e=>this._matchesCell(e)),n=t.edges.filter(e=>this._matchesEdge(e)),i=this._effectiveHints();s.length?s.forEach(e=>{const t=e.sos_put??[],n=e.sos_get??[],l=this._roleTokensForCell(e,i),a=this._fileHintTokensForCell(e,i),o=document.createElement("details");o.className="jp-CellScopePanel-cell",o.open=s.length<=4;const r=document.createElement("summary");r.textContent=`Cell ${e.idx} (${e.kernel})`,o.appendChild(r);const c=document.createElement("div");c.className="jp-CellScopePanel-quickActions";const d=document.createElement("button");d.textContent="Activate cell",d.className="jp-mod-styled",d.disabled=!this.tracker||!this.tracker.currentWidget,d.addEventListener("click",()=>{this._activateCell(e.idx)}),c.appendChild(d),o.appendChild(c);const h=document.createElement("div");h.className="jp-CellScopePanel-cellBody",h.append(this._renderList("Functions",e.funcs),this._renderList("Defined Vars",e.var_defs),this._renderList("Used Vars",e.var_uses),this._renderList("File Writes",e.file_writes),this._renderList("File Reads",e.file_reads),this._renderList("SoS put",t),this._renderList("SoS get",n),this._renderList("Roles",l),this._renderList("File metadata",a)),o.appendChild(h),this._resultsNode.appendChild(o)}):this._resultsNode.textContent="No cells match the current filters.";const l=document.createElement("h4");if(l.textContent="Edges",this._edgesNode.appendChild(l),n.length){const e=document.createElement("ul");n.forEach(t=>{const s=[];void 0!==t.source&&void 0!==t.target&&s.push(`Cell ${t.source} → Cell ${t.target}`),t.type&&s.push(`type: ${t.type}`),t.vars?.length&&s.push(`vars: ${t.vars.join(", ")}`);const n=t.via??"ast";s.push(`via ${n}`);const i=document.createElement("li");i.textContent=s.join(" | "),e.appendChild(i)}),this._edgesNode.appendChild(e)}else{const e=document.createElement("p");e.textContent="No edges match the current filters.",this._edgesNode.appendChild(e)}e&&this._emitFilterChange(s.length,n.length)}_matchesCell(e){const{search:t,kernels:s,requireFileReads:n,requireFileWrites:i,requireSos:l,roles:a,fileHints:o}=this._filterState,r=e.sos_put??[],c=e.sos_get??[],d=this._effectiveHints(),h=this._roleTokensForCell(e,d),p=this._fileHintTokensForCell(e,d);if(s&&s.size>0&&!s.has(e.kernel))return!1;if(i&&0===e.file_writes.length)return!1;if(n&&0===e.file_reads.length)return!1;if(l&&0===r.length&&0===c.length)return!1;if(a&&a.size>0&&!h.some(e=>a.has(e)))return!1;if(o&&o.size>0&&!p.some(e=>o.has(e)))return!1;const u=t.trim().toLowerCase();if(!u)return!0;const _=this._hintTokensForCell(e,d);return[`cell ${e.idx}`,e.kernel,...e.funcs,...e.var_defs,...e.var_uses,...e.file_writes,...e.file_reads,...r,...c,..._].join(" ").toLowerCase().includes(u)}_matchesEdge(e){const{edgeVia:t,search:s}=this._filterState,n=(e.via??"ast").toString();if(t&&t.size>0&&!t.has(n))return!1;const i=s.trim().toLowerCase();if(!i)return!0;const l=[];return void 0!==e.source&&void 0!==e.target&&(l.push(`cell ${e.source}`),l.push(`cell ${e.target}`)),e.type&&l.push(e.type),l.push(n),e.vars?.length&&l.push(...e.vars),l.join(" ").toLowerCase().includes(i)}_toggleFacet(e,t,s,n){if(!n.length)return null;const i=new Set(n),l=null===e?new Set(i):new Set(e);return s?l.add(t):l.delete(t),0===l.size?null:l.size===i.size?1===i.size?l:null:l}_facetIsAll(e,t){return!t.length||null===e||e.size===t.length}_sanitizeFacet(e,t){if(!t.length)return null;if(null===e)return null;const s=new Set;return t.forEach(t=>{e.has(t)&&s.add(t)}),0===s.size?null:s.size===t.length?1===t.length?s:null:s}_createToggle(e,t,s){const n=document.createElement("label");n.className="jp-CellScopeFilters-toggle";const i=document.createElement("input");return i.type="checkbox",i.checked=t,i.addEventListener("change",()=>{s(i.checked)}),n.append(i,document.createTextNode(e)),n}_activateCell(e){const t=this.tracker?.currentWidget;if(!t)return void this._setStatus("Open a notebook to activate cells.","warn");const{content:s}=t;if(!s)return;let n=-1,i=-1;const l=s.widgets.length;for(let t=0;t<l;t++){const l=s.widgets[t];if("code"===l?.model?.type&&(n+=1,n===e)){i=t;break}}-1!==i?(s.activeCellIndex=i,s.deselectAll(),s.scrollToItem(i),this.app.shell.activateById(t.id)):this._setStatus(`Could not locate code cell ${e}.`,"warn")}_updateFilters(e){e(),this._saveFilterState(),this._renderFilteredView(!0)}_effectiveHints(){return this._lastReview?.hints??this._storedHints}_roleTokensForCell(e,t){if(!t?.roles)return[];const s=new Set,n=[];return[...e.var_defs,...e.var_uses].forEach(e=>{const i=t.roles?.[e];i&&!s.has(i)&&(s.add(i),n.push(i))}),n}_fileHintTokensForCell(e,t){if(!t?.domains)return[];const s=new Set,n=t.domains??{},i=new Set;return[...e.file_writes,...e.file_reads].forEach(e=>i.add(h(e))),i.forEach(e=>{const t=n[e];t&&Object.entries(t).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>s.add(`${e}: ${t}`)):null!=t&&s.add(`${e}: ${t}`)})}),Array.from(s)}_hintTokensForCell(e,t){const s=t??this._effectiveHints();if(!s)return[];const n=new Set;return this._roleTokensForCell(e,s).forEach(e=>n.add(e)),this._fileHintTokensForCell(e,s).forEach(e=>n.add(e)),Array.from(n)}_createDefaultFilterState(){return{search:"",kernels:null,requireFileWrites:!1,requireFileReads:!1,requireSos:!1,edgeVia:null,roles:null,fileHints:null}}_serializeFilterState(){const e=e=>e&&0!==e.size?Array.from(e).sort((e,t)=>e.localeCompare(t)):null;return{search:this._filterState.search,kernels:e(this._filterState.kernels),requireFileWrites:this._filterState.requireFileWrites,requireFileReads:this._filterState.requireFileReads,requireSos:this._filterState.requireSos,edgeVia:e(this._filterState.edgeVia),roles:e(this._filterState.roles),fileHints:e(this._filterState.fileHints)}}_saveFilterState(){const e=this._filterStorageKey();if(e)try{window.localStorage.setItem(e,JSON.stringify(this._serializeFilterState()))}catch(e){console.debug("[cellscope] Failed to save filter state",e)}}_loadFilterState(){this._filterState=this._createDefaultFilterState();const e=this._filterStorageKey();if(e)try{const t=window.localStorage.getItem(e);if(!t)return;const s=JSON.parse(t);"string"==typeof s.search&&(this._filterState.search=s.search),null===s.kernels?this._filterState.kernels=null:Array.isArray(s.kernels)&&(this._filterState.kernels=new Set(s.kernels)),"boolean"==typeof s.requireFileWrites&&(this._filterState.requireFileWrites=s.requireFileWrites),"boolean"==typeof s.requireFileReads&&(this._filterState.requireFileReads=s.requireFileReads),"boolean"==typeof s.requireSos&&(this._filterState.requireSos=s.requireSos),null===s.edgeVia?this._filterState.edgeVia=null:Array.isArray(s.edgeVia)&&(this._filterState.edgeVia=new Set(s.edgeVia)),null===s.roles?this._filterState.roles=null:Array.isArray(s.roles)&&(this._filterState.roles=new Set(s.roles)),null===s.fileHints?this._filterState.fileHints=null:Array.isArray(s.fileHints)&&(this._filterState.fileHints=new Set(s.fileHints))}catch(e){console.debug("[cellscope] Failed to load filter state",e),this._filterState=this._createDefaultFilterState()}}_filterStorageKey(){return this._activeNotebookPath?`cellscope:filters:${encodeURIComponent(this._activeNotebookPath)}`:null}_hintsStorageKey(){return this._activeNotebookPath?`cellscope:hints:${encodeURIComponent(this._activeNotebookPath)}`:null}_persistHints(e){const t=this._hintsStorageKey();if(t)try{window.localStorage.setItem(t,JSON.stringify(e)),this._storedHints=e}catch(e){console.debug("[cellscope] Failed to persist hints",e)}}_loadStoredHints(){const e=this._hintsStorageKey();if(this._storedHints=null,e)try{const t=window.localStorage.getItem(e);if(!t)return;this._storedHints=JSON.parse(t)}catch(e){console.debug("[cellscope] Failed to load stored hints",e),this._storedHints=null}}_emitFilterChange(e,t){const s={...this._serializeFilterState(),filteredCells:e,filteredEdges:t},n=JSON.stringify(s);n!==this._lastFilterSignature&&(this._lastFilterSignature=n,document.dispatchEvent(new CustomEvent("cellscope:filters-changed",{detail:s})))}_renderList(e,t){const s=document.createElement("div");s.className="jp-CellScopePanel-section";const n=document.createElement("strong");return n.textContent=`${e}: `,s.appendChild(n),s.appendChild(document.createTextNode(t.length?t.join(", "):"—")),s}_buildGraphUrl(e){if(!e)return null;const t=e.replace(/\\/g,"/"),s=`${t.startsWith("/")?t.slice(1):t}/cell_graph.html`;return l.URLExt.join(this._settings.baseUrl,"files",s)}_currentNotebookPath(){const e=this.tracker?.currentWidget;return e?.context.path??null}_syncNotebook(){const e=this.tracker?.currentWidget??null;this._setupNotebookListeners(e??null);const t=e?.context.path??this._currentNotebookPath();this._pathNode.textContent=t??"(no notebook)",this._latestGraphUrl=null,this._graphBtn&&(this._graphBtn.disabled=!0),this._exportNode.textContent="",this._lastReview=null,this._activeNotebookPath=t,this._storedHints=null,this._lastFilterSignature="",this._cancelPendingTimer(),this._setPending(!1,void 0,!0),t?(this._loadStoredHints(),this._loadFilterState()):this._filterState=this._createDefaultFilterState()}_setBusy(e,t,s=!1){this._analyzeBtn.disabled=e,this._exportBtn.disabled=e,t?this._setStatus(t,"info"):e||s||(this._statusNode.textContent="")}_setStatus(e,t){this._statusNode.textContent=e,this._statusNode.className=`jp-CellScopePanel-status jp-mod-${t}`}async _requestAnalysis(e){const t=l.URLExt.join(this._settings.baseUrl,"cellscope","analyze"),s=await a.ServerConnection.makeRequest(t,{method:"POST",body:JSON.stringify({notebook:e}),headers:{"Content-Type":"application/json"}},this._settings);if(!s.ok)throw new a.ServerConnection.ResponseError(s);return await s.json()}async _showReviewDialog(e){const t=document.createElement("div");t.className="jp-CellScopeReview";const s=document.createElement("p");s.textContent="Review the captured metadata, adjust roles or file metadata, and confirm to generate the RO-Crate.",t.appendChild(s);const i=this._buildReviewDraft(e),l=this._lastReview?.hints??{roles:{},domains:{}},a=new Map,o=new Map,c=document.createElement("div");c.className="jp-CellScopeReview-section";const d=document.createElement("h4");if(d.textContent="Metadata adjustments",c.appendChild(d),i.variables.length||i.files.length){if(i.variables.length){const e=document.createElement("h5");e.textContent=`Variables (${i.variables.length})`,c.appendChild(e),i.variables.forEach(e=>{const t=document.createElement("label");t.className="jp-CellScopeReview-field";const s=document.createElement("span");s.className="jp-CellScopeReview-fieldLabel",s.textContent="function"===e.kind?`${e.name} (function)`:e.name,t.appendChild(s);const n=document.createElement("input");n.type="text",n.className="jp-CellScopeReview-input jp-mod-styled",n.placeholder="function"===e.kind?"Role (e.g., algorithm, helper)":"Role (e.g., dataset, parameter)";const i=l.roles?.[e.name];i&&(n.value=i),t.appendChild(n),c.appendChild(t),a.set(e.name,n)})}if(i.files.length){const e=document.createElement("h5");e.textContent=`Files (${i.files.length})`,c.appendChild(e),i.files.forEach(e=>{const t=document.createElement("div");t.className="jp-CellScopeReview-fileBlock";const s=document.createElement("div");s.className="jp-CellScopeReview-fieldLabel",s.textContent=e.path,t.appendChild(s);const n=document.createElement("input");n.type="text",n.className="jp-CellScopeReview-input jp-mod-styled",n.placeholder="MIME type (e.g., text/csv)";const i=l.domains?.[e.baseName],a=i?i.encodingFormat:void 0,r=Array.isArray(a)?a[0]??"":a??"";r&&(n.value=r),t.appendChild(n);const d=document.createElement("input");d.type="text",d.className="jp-CellScopeReview-input jp-mod-styled",d.placeholder="Tags (comma separated)";const h=i?i.keywords:void 0,p=Array.isArray(h)?h:"string"==typeof h?[h]:[];p.length&&(d.value=p.join(", ")),t.appendChild(d),c.appendChild(t),o.set(e.baseName,{mime:n,tags:d})})}}else{const e=document.createElement("p");e.textContent="No editable metadata detected for this notebook.",c.appendChild(e)}t.appendChild(c);const h=document.createElement("div");h.className="jp-CellScopeReview-section";const p=document.createElement("h4");p.textContent=`Cells (${e.cells.length})`,h.appendChild(p),e.cells.forEach(t=>{const s=document.createElement("details");s.open=e.cells.length<=3;const n=document.createElement("summary");n.textContent=`Cell ${t.idx} (${t.kernel})`,s.appendChild(n);const i=document.createElement("div");i.append(this._renderList("Functions",t.funcs),this._renderList("Defined vars",t.var_defs),this._renderList("Used vars",t.var_uses),this._renderList("File writes",t.file_writes),this._renderList("File reads",t.file_reads),this._renderList("SoS put",t.sos_put??[]),this._renderList("SoS get",t.sos_get??[])),s.appendChild(i),h.appendChild(s)}),t.appendChild(h);const u=document.createElement("div");u.className="jp-CellScopeReview-section";const _=document.createElement("h4");if(_.textContent=`Edges (${e.edges.length})`,u.appendChild(_),e.edges.length){const t=document.createElement("ul");e.edges.forEach(e=>{const s=document.createElement("li"),n=[];void 0!==e.source&&void 0!==e.target&&n.push(`${e.source} → ${e.target}`),e.type&&n.push(e.type),e.vars?.length&&n.push(`vars: ${e.vars.join(", ")}`),e.via&&n.push(`via ${e.via}`),s.textContent=n.join(" | ")||JSON.stringify(e),t.appendChild(s)}),u.appendChild(t)}else{const e=document.createElement("p");e.textContent="No edges detected.",u.appendChild(e)}t.appendChild(u);const m=document.createElement("div");m.className="jp-CellScopeReview-consent";const f=document.createElement("input");f.type="checkbox",f.id="cellscope-review-consent";const g=document.createElement("label");g.htmlFor=f.id,g.textContent="I have reviewed the metadata and want to export the crate.",m.append(f,g),t.appendChild(m);const C=new n.Dialog({title:"Review Notebook Metadata",body:new r.Widget({node:t}),buttons:[n.Dialog.cancelButton({label:"Cancel"}),n.Dialog.okButton({label:"Confirm Export"})]}),S=C.node.querySelector("button.jp-mod-accept");if(S&&(S.disabled=!0,f.addEventListener("change",()=>{S.disabled=!f.checked})),!(await C.launch()).button.accept)return null;const y={};a.forEach((e,t)=>{const s=e.value.trim();s&&(y[t]=s)});const v={};o.forEach((e,t)=>{const s={},n=e.mime.value.trim();n&&(s.encodingFormat=n);const i=e.tags.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);1===i.length?s.keywords=i[0]:i.length>1&&(s.keywords=i),Object.keys(s).length>0&&(v[t]=s)});const k={hints:{roles:y,domains:v}};return this._lastReview=k,k}_buildReviewDraft(e){const t=new Set;e.cells.forEach(e=>{e.funcs.forEach(e=>t.add(e))});const s=new Map;e.cells.forEach(e=>{e.var_defs.forEach(e=>{s.has(e)||s.set(e,{name:e,kind:t.has(e)?"function":"data"})})});const n=new Map;return e.cells.forEach(e=>{[...e.file_writes,...e.file_reads].forEach(e=>{const t=h(e);n.has(t)||n.set(t,{path:e,baseName:t})})}),{variables:Array.from(s.values()).sort((e,t)=>e.name.localeCompare(t.name)),files:Array.from(n.values()).sort((e,t)=>e.baseName.localeCompare(t.baseName))}}_stringifyError(e){if(e instanceof Error)return e.message;if(o.JSONExt.isPrimitive(e))return String(e);try{return JSON.stringify(e)}catch{return"Unknown error"}}}const u={id:"cellscope-lab:plugin",autoStart:!0,optional:[n.ICommandPalette,i.INotebookTracker],activate:(e,t,s)=>{const n=new p(e,s??null);e.shell.add(n,"left",{rank:950}),e.commands.addCommand(c,{label:"CellScope: Show Analyzer",execute:()=>{e.shell.activateById(n.id)}}),e.commands.addCommand(d,{label:"CellScope: Open Graph Panel",execute:()=>{n.openGraphView()||e.commands.execute("apputils:notify",{title:"CellScope",message:"Export a crate before opening the graph viewer.",options:{autoClose:!0}})}}),t&&(t.addItem({command:c,category:"CellScope"}),t.addItem({command:d,category:"CellScope"}))}}}}]);