"use strict";(self.webpackChunkcellscope_lab=self.webpackChunkcellscope_lab||[]).push([[821],{56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function n(e){for(var n=-1,i=0;i<t.length;i++)if(t[i].identifier===e){n=i;break}return n}function i(e,i){for(var l={},r=[],o=0;o<e.length;o++){var a=e[o],c=i.base?a[0]+i.base:a[0],d=l[c]||0,p="".concat(c," ").concat(d);l[c]=d+1;var h=n(p),u={css:a[1],media:a[2],sourceMap:a[3],supports:a[4],layer:a[5]};if(-1!==h)t[h].references++,t[h].updater(u);else{var f=s(u,i);i.byIndex=o,t.splice(o,0,{identifier:p,updater:f,references:1})}r.push(p)}return r}function s(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,s){var l=i(e=e||[],s=s||{});return function(e){e=e||[];for(var r=0;r<l.length;r++){var o=n(l[r]);t[o].references--}for(var a=i(e,s),c=0;c<l.length;c++){var d=n(l[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}l=a}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n="",i=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),i&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),i&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n}).join("")},t.i=function(e,n,i,s,l){"string"==typeof e&&(e=[[null,e,void 0]]);var r={};if(i)for(var o=0;o<this.length;o++){var a=this[o][0];null!=a&&(r[a]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);i&&r[d[0]]||(void 0!==l&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=l),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),s&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=s):d[4]="".concat(s)),t.push(d))}},t}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{e.exports=function(e){return e[1]}},646:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(601),s=n.n(i),l=n(314),r=n.n(l)()(s());r.push([e.id,".jp-CellScopePanel {\n  padding: 10px;\n  gap: 10px;\n  font-size: var(--jp-content-font-size1);\n}\n\n.jp-CellScopePanel-header {\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n  margin-bottom: 8px;\n  position: relative;\n}\n\n.jp-CellScopePanel-header h3 {\n  margin: 0;\n  font-size: var(--jp-ui-font-size1);\n  font-weight: 600;\n}\n\n.jp-CellScopePanel-row {\n  color: var(--jp-ui-font-color2);\n  font-size: var(--jp-content-font-size0);\n}\n\n.jp-CellScopePanel-controls {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 8px;\n}\n\n.jp-CellScopePanel-status {\n  margin-bottom: 4px;\n  min-height: 18px;\n  font-size: var(--jp-content-font-size0);\n  color: var(--jp-ui-font-color1);\n}\n\n.jp-CellScopePanel-status.jp-mod-warn {\n  color: var(--jp-warn-color1);\n}\n\n.jp-CellScopePanel-status.jp-mod-error {\n  color: var(--jp-error-color1);\n}\n\n.jp-CellScopePanel-pending {\n  display: none;\n  background: var(--jp-layout-color2);\n  border-left: 3px solid var(--jp-warn-color1);\n  padding: 6px 8px;\n  border-radius: var(--jp-border-radius);\n  margin-bottom: 8px;\n  font-size: var(--jp-content-font-size0);\n  color: var(--jp-ui-font-color1);\n}\n\n.jp-CellScopePanel-filtersPopover {\n  position: absolute;\n  top: 100%;\n  left: 0;\n  max-width: min(420px, 90vw);\n  max-height: 320px;\n  overflow-y: auto;\n  background: var(--jp-layout-color1);\n  border: 1px solid var(--jp-border-color2);\n  border-radius: var(--jp-border-radius);\n  box-shadow: var(--jp-elevation-z4);\n  padding: 10px 12px 12px;\n  z-index: 12;\n}\n\n.jp-CellScopePanel-filtersButton.jp-mod-active {\n  background: var(--jp-layout-color2);\n  box-shadow: var(--jp-shadow-inner);\n}\n\n.jp-CellScopePanel-filters {\n  display: grid;\n  gap: 12px;\n}\n\n.jp-CellScopeFilters-search {\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n}\n\n.jp-CellScopeFilters-search label {\n  font-weight: 600;\n  font-size: var(--jp-content-font-size0);\n}\n\n.jp-CellScopeFilters-search input {\n  width: 100%;\n}\n\n.jp-CellScopeFilters-group {\n  border: 1px solid var(--jp-border-color2);\n  border-radius: var(--jp-border-radius);\n  padding: 8px;\n  background: var(--jp-layout-color1);\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n}\n\n.jp-CellScopeFilters-group legend {\n  font-size: var(--jp-content-font-size0);\n  font-weight: 600;\n  padding: 0 6px;\n}\n\n.jp-CellScopeFilters-group label {\n  display: flex;\n  gap: 6px;\n  align-items: center;\n  font-size: var(--jp-content-font-size0);\n}\n\n.jp-CellScopeFilters-toggleGroup {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 12px;\n}\n\n.jp-CellScopeFilters-toggle {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  font-size: var(--jp-content-font-size0);\n}\n\n.jp-CellScopePanel-results {\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n}\n\n.jp-CellScopePanel-cell {\n  border: 1px solid var(--jp-border-color2);\n  border-radius: var(--jp-border-radius);\n  background: var(--jp-layout-color1);\n  padding: 4px 8px 8px;\n}\n\n.jp-CellScopePanel-cell > summary {\n  font-weight: 600;\n  cursor: pointer;\n  padding: 4px 0;\n}\n\n.jp-CellScopePanel-quickActions {\n  display: flex;\n  gap: 6px;\n  margin: 4px 0 6px;\n}\n\n.jp-CellScopePanel-cellBody {\n  display: grid;\n  gap: 6px 12px;\n  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));\n  font-size: var(--jp-content-font-size0);\n}\n\n.jp-CellScopePanel-section {\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n  font-size: var(--jp-content-font-size0);\n}\n\n.jp-CellScopePanel-section strong {\n  font-weight: 600;\n  color: var(--jp-ui-font-color1);\n}\n\n.jp-CellScopePanel-edges h4 {\n  margin: 8px 0 4px;\n  font-size: var(--jp-ui-font-size1);\n}\n\n.jp-CellScopePanel-edges ul {\n  margin: 0;\n  padding-left: 18px;\n  display: grid;\n  gap: 4px;\n  font-size: var(--jp-content-font-size0);\n}\n\n.jp-CellScopePanel-export {\n  margin-top: 8px;\n  font-size: var(--jp-content-font-size0);\n  color: var(--jp-ui-font-color2);\n}\n\n.jp-CellScopePanel-help {\n  font-size: var(--jp-content-font-size0);\n  color: var(--jp-ui-font-color2);\n}\n\n.jp-CellScopeReview {\n  display: flex;\n  flex-direction: column;\n  gap: 16px;\n  max-height: 70vh;\n  overflow-y: auto;\n  padding: 4px;\n  font-size: var(--jp-content-font-size1);\n}\n\n.jp-CellScopeReview-section {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n}\n\n.jp-CellScopeReview-section h4 {\n  margin: 0;\n  font-size: var(--jp-ui-font-size1);\n  font-weight: 600;\n}\n\n.jp-CellScopeReview-section h5 {\n  margin: 0;\n  font-size: var(--jp-content-font-size1);\n  font-weight: 600;\n  color: var(--jp-ui-font-color1);\n}\n\n.jp-CellScopeReview-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));\n  gap: 10px;\n}\n\n.jp-CellScopeReview-field,\n.jp-CellScopeReview-fileBlock {\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n  border: 1px solid var(--jp-border-color2);\n  border-radius: var(--jp-border-radius);\n  background: var(--jp-layout-color1);\n  padding: 10px;\n  box-shadow: inset 0 0 0 1px transparent;\n}\n\n.jp-CellScopeReview-fieldLabel {\n  font-weight: 600;\n  font-size: var(--jp-content-font-size0);\n  color: var(--jp-ui-font-color1);\n  word-break: break-word;\n}\n\n.jp-CellScopeReview-input {\n  width: 100%;\n}\n\n.jp-CellScopeReview-fileBlock .jp-CellScopeReview-input {\n  margin-top: 2px;\n}\n\n.jp-CellScopeReview-consent {\n  display: flex;\n  gap: 8px;\n  align-items: flex-start;\n  font-size: var(--jp-content-font-size0);\n}\n\n.jp-CellScopeReview-consent input {\n  margin-top: 4px;\n}\n\n.jp-CellScopeReview dl {\n  margin: 0;\n}\n\n.jp-CellScopeReview ul {\n  margin: 0;\n  padding-left: 18px;\n  display: grid;\n  gap: 4px;\n}\n",""]);const o=r},659:e=>{var t={};e.exports=function(e,n){var i=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(n)}},821:(e,t,n)=>{n.r(t),n.d(t,{default:()=>E});var i=n(794),s=n(722),l=n(23),r=n(296),o=n(262),a=n(256),c=n(72),d=n.n(c),p=n(825),h=n.n(p),u=n(659),f=n.n(u),_=n(56),m=n.n(_),g=n(540),v=n.n(g),C=n(113),S=n.n(C),y=n(646),x={};x.styleTagTransform=S(),x.setAttributes=m(),x.insert=f().bind(null,"head"),x.domAPI=h(),x.insertStyleElement=v(),d()(y.A,x),y.A&&y.A.locals&&y.A.locals;const b="cellscope:open-list",w="cellscope:open-graph",j=e=>{const t=e.replace(/\\/g,"/").split("/");return t[t.length-1]||e};class k extends a.Widget{constructor(e,t){super(),this.app=e,this.tracker=t,this._handleDocumentClick=e=>{if(!this._filtersVisible)return;if(!this._filterOverlay||!this._filtersBtn)return;const t=e.target;this._filterOverlay.contains(t)||this._filtersBtn.contains(t)||this._toggleFilters(!1)},this._statusNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-status",e})(),this._pendingNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-pending",e.style.display="none",e})(),this._filterNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-filters",e})(),this._resultsNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-results",e.style.paddingBottom="8px",e})(),this._edgesNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-edges",e.style.marginTop="12px",e})(),this._contentNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-content",e.style.flex="1 1 auto",e.style.overflowY="auto",e.style.paddingRight="4px",e.appendChild(this._resultsNode),e.appendChild(this._edgesNode),e})(),this._exportNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-export",e})(),this._helpNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-help",e.innerHTML="Need the graph? Export a crate, then run <code>CellScope: Open Graph Panel</code>.",e})(),this._latestGraphUrl=null,this._lastAnalysis=null,this._lastReview=null,this._storedHints=null,this._activeNotebookPath=null,this._filterState=this._createDefaultFilterState(),this._kernelOptions=[],this._edgeViaOptions=[],this._roleOptions=[],this._fileHintOptions=[],this._cellLabelMap=new Map,this._pendingTimeout=null,this._pendingChanges=!1,this._notebookListeners=[],this._observedPanel=null,this._kernelWasBusySinceLastIdle=!1,this._analyzeInFlight=!1,this._rerunAfterCurrent=!1,this._filtersVisible=!1,this._lastFilterSignature="",this.id="cellscope-analysis-panel",this.title.label="CellScope",this.title.closable=!0,this.addClass("jp-CellScopePanel"),this.node.style.display="flex",this.node.style.flexDirection="column",this.node.style.height="100%",this._settings=this.app.serviceManager.serverSettings,this.node.appendChild(this._buildHeader()),this.node.appendChild(this._statusNode),this.node.appendChild(this._pendingNode),this.node.appendChild(this._contentNode),this.node.appendChild(this._exportNode),this.node.appendChild(this._helpNode),this.tracker&&(this.tracker.currentChanged.connect(this._syncNotebook,this),this.tracker.widgetAdded.connect(this._syncNotebook,this)),this._syncNotebook()}dispose(){this.tracker&&(this.tracker.currentChanged.disconnect(this._syncNotebook,this),this.tracker.widgetAdded.disconnect(this._syncNotebook,this)),this._disposeNotebookListeners(),this._cancelPendingTimer(),super.dispose()}openGraphView(){if(!this._latestGraphUrl)return this._setStatus("Run an export before opening the graph viewer.","warn"),!1;const e=document.createElement("iframe");e.src=this._latestGraphUrl,e.style.width="100%",e.style.height="100%",e.style.border="none";const t=new a.Widget({node:document.createElement("div")});t.node.style.height="100%",t.node.appendChild(e);const n=new i.MainAreaWidget({content:t});return n.title.label="CellScope Graph",n.title.closable=!0,this.app.shell.add(n,"main"),this.app.shell.activateById(n.id),!0}_buildHeader(){const e=document.createElement("div");e.className="jp-CellScopePanel-header";const t=document.createElement("h3");t.textContent="CellScope Analyzer",e.appendChild(t);const n=document.createElement("div");n.className="jp-CellScopePanel-row";const i=document.createElement("span");i.textContent="Notebook: ",n.appendChild(i),this._pathNode=document.createElement("code"),this._pathNode.textContent="(no notebook)",n.appendChild(this._pathNode),e.appendChild(n);const s=document.createElement("div");return s.className="jp-CellScopePanel-controls",this._filtersBtn=document.createElement("button"),this._filtersBtn.textContent="Filters",this._filtersBtn.className="jp-mod-styled jp-CellScopePanel-filtersButton",this._filtersBtn.disabled=!0,this._filtersBtn.addEventListener("click",()=>{this._filtersBtn.disabled||this._toggleFilters()}),this._analyzeBtn=document.createElement("button"),this._analyzeBtn.textContent="Analyze",this._analyzeBtn.className="jp-mod-styled",this._analyzeBtn.addEventListener("click",()=>{this._analyze()}),this._exportBtn=document.createElement("button"),this._exportBtn.textContent="Export Crate",this._exportBtn.className="jp-mod-styled",this._exportBtn.addEventListener("click",()=>{this._export()}),this._graphBtn=document.createElement("button"),this._graphBtn.textContent="Open Graph",this._graphBtn.className="jp-mod-styled",this._graphBtn.disabled=!0,this._graphBtn.addEventListener("click",()=>{this.openGraphView()||this._setStatus("Export a crate before opening the graph viewer.","warn")}),s.appendChild(this._filtersBtn),s.appendChild(this._analyzeBtn),s.appendChild(this._exportBtn),s.appendChild(this._graphBtn),e.appendChild(s),this._filterOverlay=document.createElement("div"),this._filterOverlay.className="jp-CellScopePanel-filtersPopover",this._filterOverlay.style.display="none",this._filterOverlay.appendChild(this._filterNode),e.appendChild(this._filterOverlay),e}async _analyze(){await this._runAnalysis("manual")}async _export(){const e=this._currentNotebookPath();if(e){this._setBusy(!0,"Preparing review…");try{const t=await this._requestAnalysis(e);this._renderAnalysis(t),this._setBusy(!1);const n=await this._showReviewDialog(t.graph);if(!n)return void this._setStatus("Export cancelled.","warn");this._setBusy(!0,"Exporting RO-Crate…");const i=`out-lab/${Date.now()}`,s=l.URLExt.join(this._settings.baseUrl,"cellscope","export"),o=await r.ServerConnection.makeRequest(s,{method:"POST",body:JSON.stringify({notebook:e,out_dir:i,hints:n.hints}),headers:{"Content-Type":"application/json"}},this._settings);if(!o.ok)throw new r.ServerConnection.ResponseError(o);const a=await o.json(),c=a.crate;this._latestGraphUrl=this._buildGraphUrl(c),this._renderExportSummary(c,a.index??null),this._lastReview=n,this._graphBtn.disabled=!this._latestGraphUrl,this._lastAnalysis?(this._syncFilterOptions(this._lastAnalysis),this._renderFilterControls(),this._saveFilterState(),this._renderFilteredView(!0)):this._renderFilteredView(!0),this._setStatus("Export complete.","info")}catch(e){console.error(e),this._setStatus(`Failed to export crate: ${this._stringifyError(e)}`,"error")}finally{this._setBusy(!1)}}else this._setStatus("Open a notebook to export.","warn")}_renderExportSummary(e,t){const n=[];if(n.push(`Crate written to ${this._normalisePath(e)}`),t){const e="string"==typeof t.endpoint?t.endpoint:null,i="string"==typeof t.output?t.output:null,s="number"==typeof t.triples?t.triples:null,l="number"==typeof t.attempts?t.attempts:null,r="number"==typeof t.duration_seconds?t.duration_seconds:null,o="number"==typeof t.status?t.status:null;if(e){const t=l?`attempts ${l}`:"attempts n/a",i=null!==r?`in ${r.toFixed(1)}s`:"",a=null!==o?`status ${o}`:"status n/a",c=null!==s?`${s} triples`:"triples n/a";n.push(`SPARQL push → ${e} (${c}, ${a}, ${t} ${i}).`)}else{const e=i??"index/last_update.sparql",t=null!==s?`${s} triples`:"triples n/a";n.push(`SPARQL delta saved to ${this._normalisePath(e)} (${t}, endpoint not configured).`)}}this._exportNode.textContent=n.join(" • ")}_normalisePath(e){return e?e.replace(/\\/g,"/"):e}async _runAnalysis(e){const t=this._currentNotebookPath();if(t)if(this._analyzeInFlight)"auto"===e&&(this._rerunAfterCurrent=!0,this._cancelPendingTimer());else{null!==this._pendingTimeout&&(window.clearTimeout(this._pendingTimeout),this._pendingTimeout=null),this._analyzeInFlight=!0,this._rerunAfterCurrent=!1,"manual"===e?this._setBusy(!0,"Analyzing notebook…"):this._setBusy(!0,void 0,!0);try{const n=await this._requestAnalysis(t);this._renderAnalysis(n),"manual"===e?this._setStatus("Analysis complete.","info"):(this._statusNode.textContent??"").trim()||this._setStatus("Analysis refreshed.","info")}catch(e){console.error(e),this._setStatus(`Failed to analyze notebook: ${this._stringifyError(e)}`,"error")}finally{this._analyzeInFlight=!1,this._setBusy(!1,void 0,"auto"===e),this._rerunAfterCurrent?(this._setPending(!0,"Additional notebook changes detected. Refreshing analysis…"),this._scheduleAutoAnalyze("content"),this._rerunAfterCurrent=!1):this._setPending(!1)}}else"manual"===e&&this._setStatus("Open a notebook to analyze.","warn")}_renderAnalysis(e){this._lastAnalysis=e.graph,this._cellLabelMap.clear(),e.graph.cells.forEach(e=>{this._cellLabelMap.set(e.idx,this._cellLabel(e))}),this._syncFilterOptions(e.graph),this._renderFilterControls(),this._toggleFilters(!1),this._saveFilterState(),this._renderFilteredView(!0)}_handleNotebookChange(e){if(!this._lastAnalysis||!this._activeNotebookPath)return;let t;switch(e){case"save":t="Notebook saved. Refreshing analysis…";break;case"execution":t="Execution finished. Refreshing analysis…";break;default:t="Notebook changed. Refreshing analysis…"}this._setPending(!0,t),this._scheduleAutoAnalyze(e)}_scheduleAutoAnalyze(e){if(!this._lastAnalysis||!this._activeNotebookPath)return;null!==this._pendingTimeout&&window.clearTimeout(this._pendingTimeout);const t="save"===e?400:"execution"===e?800:1e3,n=this._activeNotebookPath;this._pendingTimeout=window.setTimeout(()=>{this._pendingTimeout=null,n===this._activeNotebookPath&&this._runAnalysis("auto")},t)}_setPending(e,t,n=!1){if(e)return this._pendingChanges=!0,this._pendingNode.style.display="",this._pendingNode.classList.toggle("jp-mod-warn",!0),void(this._pendingNode.textContent=t??"Notebook changes detected. Analysis will refresh shortly…");(n||null===this._pendingTimeout&&!this._rerunAfterCurrent)&&(this._pendingChanges=!1,this._pendingNode.style.display="none",this._pendingNode.classList.remove("jp-mod-warn"),this._pendingNode.textContent="")}_cancelPendingTimer(){null!==this._pendingTimeout&&(window.clearTimeout(this._pendingTimeout),this._pendingTimeout=null)}_setupNotebookListeners(e){if(this._disposeNotebookListeners(),this._observedPanel=e,this._kernelWasBusySinceLastIdle=!1,this._cancelPendingTimer(),!e)return void this._setPending(!1,void 0,!0);const{context:t}=e;if(!t)return;const n=(e,t)=>{"completed"===t&&this._handleNotebookChange("save")};t.saveState.connect(n,this),this._notebookListeners.push(()=>t.saveState.disconnect(n,this));const i=t.sessionContext;if(i){const e=(e,t)=>{this._onKernelStatusChanged(t)};i.statusChanged.connect(e,this),this._notebookListeners.push(()=>i.statusChanged.disconnect(e,this))}}_disposeNotebookListeners(){for(;this._notebookListeners.length;){const e=this._notebookListeners.pop();try{e?.()}catch(e){console.debug("[cellscope] Failed to detach notebook listener",e)}}this._observedPanel=null,this._kernelWasBusySinceLastIdle=!1}_onKernelStatusChanged(e){if(this._lastAnalysis&&this._activeNotebookPath){if("busy"!==e)return"idle"===e&&this._kernelWasBusySinceLastIdle?(this._kernelWasBusySinceLastIdle=!1,void this._handleNotebookChange("execution")):void("restarting"!==e&&"dead"!==e&&"terminating"!==e||(this._kernelWasBusySinceLastIdle=!1));this._kernelWasBusySinceLastIdle=!0}}_syncFilterOptions(e){this._kernelOptions=Array.from(new Set(e.cells.map(e=>e.kernel))).sort((e,t)=>e.localeCompare(t)),this._filterState.kernels=this._sanitizeFacet(this._filterState.kernels,this._kernelOptions);const t=new Set;e.edges.forEach(e=>{e.via&&t.add(String(e.via))}),0===t.size&&t.add("ast"),this._edgeViaOptions=Array.from(t).sort((e,t)=>e.localeCompare(t)),this._filterState.edgeVia=this._sanitizeFacet(this._filterState.edgeVia,this._edgeViaOptions);const n=this._effectiveHints(),i=new Set;n?.roles&&Object.values(n.roles).forEach(e=>{e&&i.add(String(e))}),this._roleOptions=Array.from(i).sort((e,t)=>e.localeCompare(t)),this._filterState.roles=this._sanitizeFacet(this._filterState.roles,this._roleOptions);const s=new Set;n?.domains&&Object.entries(n.domains).forEach(([e,t])=>{t&&Object.entries(t).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>s.add(`${e}: ${t}`)):null!=t&&s.add(`${e}: ${t}`)})}),this._fileHintOptions=Array.from(s).sort((e,t)=>e.localeCompare(t)),this._filterState.fileHints=this._sanitizeFacet(this._filterState.fileHints,this._fileHintOptions)}_renderFilterControls(){const e=this._lastAnalysis;if(this._filterNode.innerHTML="",!e)return this._filtersBtn.disabled=!0,this._filtersBtn.textContent="Filters",void this._toggleFilters(!1);this._filtersBtn.disabled=!1;const t=document.createElement("div");t.className="jp-CellScopeFilters-search";const n=document.createElement("label");n.textContent="Search";const i=document.createElement("input");if(i.type="search",i.placeholder="Search cells, files, variables…",i.value=this._filterState.search,i.addEventListener("input",()=>{this._updateFilters(()=>{this._filterState.search=i.value})}),t.append(n,i),this._filterNode.appendChild(t),this._kernelOptions.length>1){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="Kernel",e.appendChild(t),this._kernelOptions.forEach(t=>{const n=document.createElement("label"),i=document.createElement("input");i.type="checkbox";const s=this._filterState.kernels,l=this._facetIsAll(s,this._kernelOptions)||!!s&&s.has(t);i.checked=l,i.addEventListener("change",()=>{this._updateFilters(()=>{this._filterState.kernels=this._toggleFacet(this._filterState.kernels,t,i.checked,this._kernelOptions)})}),n.append(i,document.createTextNode(t)),e.appendChild(n)}),this._filterNode.appendChild(e)}const s=document.createElement("div");if(s.className="jp-CellScopeFilters-toggleGroup",s.appendChild(this._createToggle("Only cells that write files",this._filterState.requireFileWrites,e=>this._updateFilters(()=>{this._filterState.requireFileWrites=e}))),s.appendChild(this._createToggle("Only cells that read files",this._filterState.requireFileReads,e=>this._updateFilters(()=>{this._filterState.requireFileReads=e}))),s.appendChild(this._createToggle("Only SoS exchanges",this._filterState.requireSos,e=>this._updateFilters(()=>{this._filterState.requireSos=e}))),this._filterNode.appendChild(s),this._roleOptions.length){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="Roles",e.appendChild(t),this._roleOptions.forEach(t=>{const n=document.createElement("label"),i=document.createElement("input");i.type="checkbox";const s=this._filterState.roles,l=this._facetIsAll(s,this._roleOptions)||!!s&&s.has(t);i.checked=l,i.addEventListener("change",()=>{this._updateFilters(()=>{this._filterState.roles=this._toggleFacet(this._filterState.roles,t,i.checked,this._roleOptions)})}),n.append(i,document.createTextNode(t)),e.appendChild(n)}),this._filterNode.appendChild(e)}if(this._fileHintOptions.length){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="File metadata",e.appendChild(t),this._fileHintOptions.forEach(t=>{const n=document.createElement("label"),i=document.createElement("input");i.type="checkbox";const s=this._filterState.fileHints,l=this._facetIsAll(s,this._fileHintOptions)||!!s&&s.has(t);i.checked=l,i.addEventListener("change",()=>{this._updateFilters(()=>{this._filterState.fileHints=this._toggleFacet(this._filterState.fileHints,t,i.checked,this._fileHintOptions)})}),n.append(i,document.createTextNode(t)),e.appendChild(n)}),this._filterNode.appendChild(e)}if(this._edgeViaOptions.length>1){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="Edge via",e.appendChild(t),this._edgeViaOptions.forEach(t=>{const n=document.createElement("label"),i=document.createElement("input");i.type="checkbox";const s=this._filterState.edgeVia,l=this._facetIsAll(s,this._edgeViaOptions)||!!s&&s.has(t);i.checked=l,i.addEventListener("change",()=>{this._updateFilters(()=>{this._filterState.edgeVia=this._toggleFacet(this._filterState.edgeVia,t,i.checked,this._edgeViaOptions)})}),n.append(i,document.createTextNode(t)),e.appendChild(n)}),this._filterNode.appendChild(e)}}_renderFilteredView(e=!1){const t=this._lastAnalysis;if(this._resultsNode.innerHTML="",this._edgesNode.innerHTML="",!t)return void(this._resultsNode.textContent="Run Analyze to see notebook metadata.");const n=t.cells.filter(e=>this._matchesCell(e)),i=t.edges.filter(e=>this._matchesEdge(e)),s=this._effectiveHints();n.length?n.forEach(e=>{const t=e.sos_put??[],i=e.sos_get??[],l=this._roleTokensForCell(e,s),r=this._fileHintTokensForCell(e,s),o=document.createElement("details");o.className="jp-CellScopePanel-cell",o.open=n.length<=4;const a=document.createElement("summary");a.textContent=this._cellSummary(e),o.appendChild(a);const c=document.createElement("div");c.className="jp-CellScopePanel-quickActions";const d=document.createElement("button");d.textContent="Activate cell",d.className="jp-mod-styled",d.disabled=!this.tracker||!this.tracker.currentWidget,d.addEventListener("click",()=>{this._activateCell(e.idx)}),c.appendChild(d),o.appendChild(c);const p=document.createElement("div");p.className="jp-CellScopePanel-cellBody",p.append(this._renderList("Functions",e.funcs),this._renderList("Defined Vars",e.var_defs),this._renderList("Used Vars",e.var_uses),this._renderList("File Writes",e.file_writes),this._renderList("File Reads",e.file_reads),this._renderList("SoS put",t),this._renderList("SoS get",i),this._renderList("Roles",l),this._renderList("File metadata",r)),o.appendChild(p),this._resultsNode.appendChild(o)}):this._resultsNode.textContent="No cells match the current filters.";const l=document.createElement("h4");if(l.textContent="Edges",this._edgesNode.appendChild(l),i.length){const e=document.createElement("ul");i.forEach(t=>{const n=[];if(void 0!==t.source&&void 0!==t.target){const e=this._formatCellReference(t.source),i=this._formatCellReference(t.target);e&&i&&n.push(`${e} → ${i}`)}t.type&&n.push(`type: ${t.type}`),t.vars?.length&&n.push(`vars: ${t.vars.join(", ")}`);const i=t.via??"ast";n.push(`via ${i}`);const s=document.createElement("li");s.textContent=n.join(" | "),e.appendChild(s)}),this._edgesNode.appendChild(e)}else{const e=document.createElement("p");e.textContent="No edges match the current filters.",this._edgesNode.appendChild(e)}e&&this._emitFilterChange(n.length,i.length)}_matchesCell(e){const{search:t,kernels:n,requireFileReads:i,requireFileWrites:s,requireSos:l,roles:r,fileHints:o}=this._filterState,a=e.sos_put??[],c=e.sos_get??[],d=this._effectiveHints(),p=this._roleTokensForCell(e,d),h=this._fileHintTokensForCell(e,d);if(n&&n.size>0&&!n.has(e.kernel))return!1;if(s&&0===e.file_writes.length)return!1;if(i&&0===e.file_reads.length)return!1;if(l&&0===a.length&&0===c.length)return!1;if(r&&r.size>0&&!p.some(e=>r.has(e)))return!1;if(o&&o.size>0&&!h.some(e=>o.has(e)))return!1;const u=t.trim().toLowerCase();if(!u)return!0;const f=this._hintTokensForCell(e,d);return[this._cellLabel(e),`cell ${e.idx}`,e.kernel,...e.funcs,...e.var_defs,...e.var_uses,...e.file_writes,...e.file_reads,...a,...c,...f].join(" ").toLowerCase().includes(u)}_matchesEdge(e){const{edgeVia:t,search:n}=this._filterState,i=(e.via??"ast").toString();if(t&&t.size>0&&!t.has(i))return!1;const s=n.trim().toLowerCase();if(!s)return!0;const l=[];if(void 0!==e.source&&void 0!==e.target){l.push(`cell ${e.source}`),l.push(`cell ${e.target}`);const t=this._formatCellReference(e.source),n=this._formatCellReference(e.target);t&&l.push(t),n&&l.push(n)}return e.type&&l.push(e.type),l.push(i),e.vars?.length&&l.push(...e.vars),l.join(" ").toLowerCase().includes(s)}_toggleFacet(e,t,n,i){if(!i.length)return null;const s=new Set(i),l=null===e?new Set(s):new Set(e);return n?l.add(t):l.delete(t),0===l.size?null:l.size===s.size?1===s.size?l:null:l}_facetIsAll(e,t){return!t.length||null===e||e.size===t.length}_sanitizeFacet(e,t){if(!t.length)return null;if(null===e)return null;const n=new Set;return t.forEach(t=>{e.has(t)&&n.add(t)}),0===n.size?null:n.size===t.length?1===t.length?n:null:n}_createToggle(e,t,n){const i=document.createElement("label");i.className="jp-CellScopeFilters-toggle";const s=document.createElement("input");return s.type="checkbox",s.checked=t,s.addEventListener("change",()=>{n(s.checked)}),i.append(s,document.createTextNode(e)),i}_activateCell(e){const t=this.tracker?.currentWidget;if(!t)return void this._setStatus("Open a notebook to activate cells.","warn");const{content:n}=t;if(!n)return;let i=-1,s=-1;const l=n.widgets.length;for(let t=0;t<l;t++){const l=n.widgets[t];if("code"===l?.model?.type&&(i+=1,i===e)){s=t;break}}-1!==s?(n.activeCellIndex=s,n.deselectAll(),n.scrollToItem(s),this.app.shell.activateById(t.id)):this._setStatus(`Could not locate code cell ${e}.`,"warn")}_cellLabel(e){return(e.name??"").trim()||`Cell ${e.idx}`}_cellSummary(e){return`${this._cellLabel(e)} (cell ${e.idx}, ${e.kernel})`}_formatCellReference(e){if("number"==typeof e){const t=this._cellLabelMap.get(e);return t?`${t} (cell ${e})`:`Cell ${e}`}return"string"==typeof e?e:null}_updateFilters(e){e(),this._saveFilterState(),this._renderFilteredView(!0)}_effectiveHints(){return this._lastReview?.hints??this._storedHints}_roleTokensForCell(e,t){if(!t?.roles)return[];const n=new Set,i=[];return[...e.var_defs,...e.var_uses].forEach(e=>{const s=t.roles?.[e];s&&!n.has(s)&&(n.add(s),i.push(s))}),i}_fileHintTokensForCell(e,t){if(!t?.domains)return[];const n=new Set,i=t.domains??{},s=new Set;return[...e.file_writes,...e.file_reads].forEach(e=>s.add(j(e))),s.forEach(e=>{const t=i[e];t&&Object.entries(t).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>n.add(`${e}: ${t}`)):null!=t&&n.add(`${e}: ${t}`)})}),Array.from(n)}_hintTokensForCell(e,t){const n=t??this._effectiveHints();if(!n)return[];const i=new Set;return this._roleTokensForCell(e,n).forEach(e=>i.add(e)),this._fileHintTokensForCell(e,n).forEach(e=>i.add(e)),Array.from(i)}_createDefaultFilterState(){return{search:"",kernels:null,requireFileWrites:!1,requireFileReads:!1,requireSos:!1,edgeVia:null,roles:null,fileHints:null}}_serializeFilterState(){const e=e=>e&&0!==e.size?Array.from(e).sort((e,t)=>e.localeCompare(t)):null;return{search:this._filterState.search,kernels:e(this._filterState.kernels),requireFileWrites:this._filterState.requireFileWrites,requireFileReads:this._filterState.requireFileReads,requireSos:this._filterState.requireSos,edgeVia:e(this._filterState.edgeVia),roles:e(this._filterState.roles),fileHints:e(this._filterState.fileHints)}}_saveFilterState(){const e=this._filterStorageKey();if(e)try{window.localStorage.setItem(e,JSON.stringify(this._serializeFilterState()))}catch(e){console.debug("[cellscope] Failed to save filter state",e)}}_loadFilterState(){this._filterState=this._createDefaultFilterState();const e=this._filterStorageKey();if(e)try{const t=window.localStorage.getItem(e);if(!t)return;const n=JSON.parse(t);"string"==typeof n.search&&(this._filterState.search=n.search),null===n.kernels?this._filterState.kernels=null:Array.isArray(n.kernels)&&(this._filterState.kernels=new Set(n.kernels)),"boolean"==typeof n.requireFileWrites&&(this._filterState.requireFileWrites=n.requireFileWrites),"boolean"==typeof n.requireFileReads&&(this._filterState.requireFileReads=n.requireFileReads),"boolean"==typeof n.requireSos&&(this._filterState.requireSos=n.requireSos),null===n.edgeVia?this._filterState.edgeVia=null:Array.isArray(n.edgeVia)&&(this._filterState.edgeVia=new Set(n.edgeVia)),null===n.roles?this._filterState.roles=null:Array.isArray(n.roles)&&(this._filterState.roles=new Set(n.roles)),null===n.fileHints?this._filterState.fileHints=null:Array.isArray(n.fileHints)&&(this._filterState.fileHints=new Set(n.fileHints))}catch(e){console.debug("[cellscope] Failed to load filter state",e),this._filterState=this._createDefaultFilterState()}}_filterStorageKey(){return this._activeNotebookPath?`cellscope:filters:${encodeURIComponent(this._activeNotebookPath)}`:null}_hintsStorageKey(){return this._activeNotebookPath?`cellscope:hints:${encodeURIComponent(this._activeNotebookPath)}`:null}_persistHints(e){const t=this._hintsStorageKey();if(t)try{window.localStorage.setItem(t,JSON.stringify(e)),this._storedHints=e}catch(e){console.debug("[cellscope] Failed to persist hints",e)}}_loadStoredHints(){const e=this._hintsStorageKey();if(this._storedHints=null,e)try{const t=window.localStorage.getItem(e);if(!t)return;this._storedHints=JSON.parse(t)}catch(e){console.debug("[cellscope] Failed to load stored hints",e),this._storedHints=null}}_emitFilterChange(e,t){const n={...this._serializeFilterState(),filteredCells:e,filteredEdges:t},i=JSON.stringify(n);i!==this._lastFilterSignature&&(this._lastFilterSignature=i,document.dispatchEvent(new CustomEvent("cellscope:filters-changed",{detail:n})))}_renderList(e,t){const n=document.createElement("div");n.className="jp-CellScopePanel-section";const i=document.createElement("strong");return i.textContent=`${e}: `,n.appendChild(i),n.appendChild(document.createTextNode(t.length?t.join(", "):"—")),n}_buildGraphUrl(e){if(!e)return null;const t=e.replace(/\\/g,"/"),n=`${t.startsWith("/")?t.slice(1):t}/cell_graph.html`;return l.URLExt.join(this._settings.baseUrl,"files",n)}_currentNotebookPath(){const e=this.tracker?.currentWidget;return e?.context.path??null}_syncNotebook(){const e=this.tracker?.currentWidget??null;this._setupNotebookListeners(e??null);const t=e?.context.path??this._currentNotebookPath();this._pathNode.textContent=t??"(no notebook)",this._latestGraphUrl=null,this._graphBtn&&(this._graphBtn.disabled=!0),this._exportNode.textContent="",this._lastReview=null,this._activeNotebookPath=t,this._storedHints=null,this._lastFilterSignature="",this._cancelPendingTimer(),this._setPending(!1,void 0,!0),t?(this._loadStoredHints(),this._loadFilterState()):this._filterState=this._createDefaultFilterState()}_setBusy(e,t,n=!1){this._analyzeBtn.disabled=e,this._exportBtn.disabled=e,t?this._setStatus(t,"info"):e||n||(this._statusNode.textContent="");const i=(this._filterState.search.trim()?1:0)+(this._filterState.kernels&&this._filterState.kernels.size>0?1:0)+(this._filterState.roles&&this._filterState.roles.size>0?1:0)+(this._filterState.fileHints&&this._filterState.fileHints.size>0?1:0)+(this._filterState.edgeVia&&this._filterState.edgeVia.size>0?1:0)+(this._filterState.requireFileReads?1:0)+(this._filterState.requireFileWrites?1:0)+(this._filterState.requireSos?1:0);this._filtersBtn.textContent=i?`Filters (${i})`:"Filters",i||this._toggleFilters(!1)}_toggleFilters(e){const t=e??!this._filtersVisible;if(this._filtersBtn&&this._filterOverlay&&(!t||!this._filtersBtn.disabled)){if(this._filtersVisible=t,t){const e=this._filtersBtn.getBoundingClientRect(),t=this.node.getBoundingClientRect(),n=t.right-e.left,i=Math.min(420,Math.max(260,n-16));this._filterOverlay.style.width=`${i}px`,this._filterOverlay.style.left=`${Math.min(e.left-t.left,t.width-i-8)}px`,this._filterOverlay.style.top=e.bottom-t.top+4+"px"}this._filterOverlay.style.display=t?"block":"none",this._filtersBtn.classList.toggle("jp-mod-active",t),t&&(this._filterOverlay.scrollTop=0)}}_setStatus(e,t){this._statusNode.textContent=e,this._statusNode.className=`jp-CellScopePanel-status jp-mod-${t}`}async _requestAnalysis(e){const t=l.URLExt.join(this._settings.baseUrl,"cellscope","analyze"),n=await r.ServerConnection.makeRequest(t,{method:"POST",body:JSON.stringify({notebook:e}),headers:{"Content-Type":"application/json"}},this._settings);if(!n.ok)throw new r.ServerConnection.ResponseError(n);return await n.json()}async _showReviewDialog(e){const t=document.createElement("div");t.className="jp-CellScopeReview";const n=document.createElement("p");n.textContent="Review the captured metadata, adjust roles or file metadata, and confirm to generate the RO-Crate.",t.appendChild(n);const s=this._buildReviewDraft(e),l=this._lastReview?.hints??{roles:{},domains:{}},r=new Map,o=new Map,c=document.createElement("div");c.className="jp-CellScopeReview-section";const d=document.createElement("h4");if(d.textContent="Metadata adjustments",c.appendChild(d),s.variables.length||s.files.length){if(s.variables.length){const e=document.createElement("h5");e.textContent=`Variables (${s.variables.length})`,c.appendChild(e);const t=document.createElement("div");t.className="jp-CellScopeReview-grid",s.variables.forEach(e=>{const n=document.createElement("label");n.className="jp-CellScopeReview-field";const i=document.createElement("span");i.className="jp-CellScopeReview-fieldLabel",i.textContent="function"===e.kind?`${e.name} (function)`:e.name,n.appendChild(i);const s=document.createElement("input");s.type="text",s.className="jp-CellScopeReview-input jp-mod-styled",s.placeholder="function"===e.kind?"Role (e.g., algorithm, helper)":"Role (e.g., dataset, parameter)";const o=l.roles?.[e.name];o&&(s.value=o),n.appendChild(s),t.appendChild(n),r.set(e.name,s)}),c.appendChild(t)}if(s.files.length){const e=document.createElement("h5");e.textContent=`Files (${s.files.length})`,c.appendChild(e);const t=document.createElement("div");t.className="jp-CellScopeReview-grid",s.files.forEach(e=>{const n=document.createElement("div");n.className="jp-CellScopeReview-fileBlock";const i=document.createElement("div");i.className="jp-CellScopeReview-fieldLabel",i.textContent=e.path.replace(/\\/g,"/"),n.appendChild(i);const s=document.createElement("input");s.type="text",s.className="jp-CellScopeReview-input jp-mod-styled",s.placeholder="MIME type (e.g., text/csv)";const r=l.domains?.[e.baseName],a=r?r.encodingFormat:void 0,c=Array.isArray(a)?a[0]??"":a??"";c&&(s.value=c),n.appendChild(s);const d=document.createElement("input");d.type="text",d.className="jp-CellScopeReview-input jp-mod-styled",d.placeholder="Tags (comma separated)";const p=r?r.keywords:void 0,h=Array.isArray(p)?p:"string"==typeof p?[p]:[];h.length&&(d.value=h.join(", ")),n.appendChild(d),t.appendChild(n),o.set(e.baseName,{mime:s,tags:d})}),c.appendChild(t)}}else{const e=document.createElement("p");e.textContent="No editable metadata detected for this notebook.",c.appendChild(e)}t.appendChild(c);const p=document.createElement("div");p.className="jp-CellScopeReview-section";const h=document.createElement("h4");h.textContent=`Cells (${e.cells.length})`,p.appendChild(h),e.cells.forEach(t=>{const n=document.createElement("details");n.open=e.cells.length<=3;const i=document.createElement("summary");i.textContent=this._cellSummary(t),n.appendChild(i);const s=document.createElement("div");s.append(this._renderList("Functions",t.funcs),this._renderList("Defined vars",t.var_defs),this._renderList("Used vars",t.var_uses),this._renderList("File writes",t.file_writes),this._renderList("File reads",t.file_reads),this._renderList("SoS put",t.sos_put??[]),this._renderList("SoS get",t.sos_get??[])),n.appendChild(s),p.appendChild(n)}),t.appendChild(p);const u=document.createElement("div");u.className="jp-CellScopeReview-section";const f=document.createElement("h4");if(f.textContent=`Edges (${e.edges.length})`,u.appendChild(f),e.edges.length){const t=document.createElement("ul");e.edges.forEach(e=>{const n=document.createElement("li"),i=[];if(void 0!==e.source&&void 0!==e.target){const t=this._formatCellReference(e.source),n=this._formatCellReference(e.target);t&&n&&i.push(`${t} → ${n}`)}e.type&&i.push(e.type),e.vars?.length&&i.push(`vars: ${e.vars.join(", ")}`),e.via&&i.push(`via ${e.via}`),n.textContent=i.join(" | ")||JSON.stringify(e),t.appendChild(n)}),u.appendChild(t)}else{const e=document.createElement("p");e.textContent="No edges detected.",u.appendChild(e)}t.appendChild(u);const _=document.createElement("div");_.className="jp-CellScopeReview-consent";const m=document.createElement("input");m.type="checkbox",m.id="cellscope-review-consent";const g=document.createElement("label");g.htmlFor=m.id,g.textContent="I have reviewed the metadata and want to export the crate.",_.append(m,g),t.appendChild(_);const v=new i.Dialog({title:"Review Notebook Metadata",body:new a.Widget({node:t}),buttons:[i.Dialog.cancelButton({label:"Cancel"}),i.Dialog.okButton({label:"Confirm Export"})]}),C=v.node.querySelector("button.jp-mod-accept");if(C&&(C.disabled=!0,m.addEventListener("change",()=>{C.disabled=!m.checked})),!(await v.launch()).button.accept)return null;const S={};r.forEach((e,t)=>{const n=e.value.trim();n&&(S[t]=n)});const y={};o.forEach((e,t)=>{const n={},i=e.mime.value.trim();i&&(n.encodingFormat=i);const s=e.tags.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);1===s.length?n.keywords=s[0]:s.length>1&&(n.keywords=s),Object.keys(n).length>0&&(y[t]=n)});const x={hints:{roles:S,domains:y}};return this._lastReview=x,x}_buildReviewDraft(e){const t=new Set;e.cells.forEach(e=>{e.funcs.forEach(e=>t.add(e))});const n=new Map;e.cells.forEach(e=>{e.var_defs.forEach(e=>{n.has(e)||n.set(e,{name:e,kind:t.has(e)?"function":"data"})})});const i=new Map;return e.cells.forEach(e=>{[...e.file_writes,...e.file_reads].forEach(e=>{const t=j(e);i.has(t)||i.set(t,{path:e,baseName:t})})}),{variables:Array.from(n.values()).sort((e,t)=>e.name.localeCompare(t.name)),files:Array.from(i.values()).sort((e,t)=>e.baseName.localeCompare(t.baseName))}}_stringifyError(e){if(e instanceof Error)return e.message;if(o.JSONExt.isPrimitive(e))return String(e);try{return JSON.stringify(e)}catch{return"Unknown error"}}}const E={id:"cellscope-lab:plugin",autoStart:!0,optional:[i.ICommandPalette,s.INotebookTracker],activate:(e,t,n)=>{const i=new k(e,n??null);e.shell.add(i,"left",{rank:950}),e.commands.addCommand(b,{label:"CellScope: Show Analyzer",execute:()=>{e.shell.activateById(i.id)}}),e.commands.addCommand(w,{label:"CellScope: Open Graph Panel",execute:()=>{i.openGraphView()||e.commands.execute("apputils:notify",{title:"CellScope",message:"Export a crate before opening the graph viewer.",options:{autoClose:!0}})}}),t&&(t.addItem({command:b,category:"CellScope"}),t.addItem({command:w,category:"CellScope"}))}}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var i="";n.supports&&(i+="@supports (".concat(n.supports,") {")),n.media&&(i+="@media ".concat(n.media," {"));var s=void 0!==n.layer;s&&(i+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),i+=n.css,s&&(i+="}"),n.media&&(i+="}"),n.supports&&(i+="}");var l=n.sourceMap;l&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(l))))," */")),t.styleTagTransform(i,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}}]);