"use strict";(self.webpackChunkcellscope_lab=self.webpackChunkcellscope_lab||[]).push([[509],{509:(e,t,s)=>{s.r(t),s.d(t,{default:()=>u});var n=s(794),a=s(722),i=s(23),l=s(296),o=s(262),r=s(256);const c="cellscope:open-list",d="cellscope:open-graph",h=e=>{const t=e.replace(/\\/g,"/").split("/");return t[t.length-1]||e};class p extends r.Widget{constructor(e,t){super(),this.app=e,this.tracker=t,this._statusNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-status",e})(),this._filterNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-filters",e.style.display="none",e})(),this._resultsNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-results",e.style.paddingBottom="8px",e})(),this._edgesNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-edges",e.style.marginTop="12px",e})(),this._contentNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-content",e.style.flex="1 1 auto",e.style.overflowY="auto",e.style.paddingRight="4px",e.appendChild(this._resultsNode),e.appendChild(this._edgesNode),e})(),this._exportNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-export",e})(),this._helpNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-help",e.innerHTML="Need the graph? Export a crate, then run <code>CellScope: Open Graph Panel</code>.",e})(),this._latestGraphUrl=null,this._lastAnalysis=null,this._lastReview=null,this._filterState={search:"",kernels:new Set,requireFileWrites:!1,requireFileReads:!1,requireSos:!1,edgeVia:new Set},this._kernelOptions=[],this._edgeViaOptions=[],this.id="cellscope-analysis-panel",this.title.label="CellScope",this.title.closable=!0,this.addClass("jp-CellScopePanel"),this.node.style.display="flex",this.node.style.flexDirection="column",this.node.style.height="100%",this._settings=this.app.serviceManager.serverSettings,this.node.appendChild(this._buildHeader()),this.node.appendChild(this._statusNode),this.node.appendChild(this._filterNode),this.node.appendChild(this._contentNode),this.node.appendChild(this._exportNode),this.node.appendChild(this._helpNode),this.tracker&&(this.tracker.currentChanged.connect(this._syncNotebook,this),this.tracker.widgetAdded.connect(this._syncNotebook,this)),this._syncNotebook()}dispose(){this.tracker&&(this.tracker.currentChanged.disconnect(this._syncNotebook,this),this.tracker.widgetAdded.disconnect(this._syncNotebook,this)),super.dispose()}openGraphView(){if(!this._latestGraphUrl)return this._setStatus("Run an export before opening the graph viewer.","warn"),!1;const e=document.createElement("iframe");e.src=this._latestGraphUrl,e.style.width="100%",e.style.height="100%",e.style.border="none";const t=new r.Widget({node:document.createElement("div")});t.node.style.height="100%",t.node.appendChild(e);const s=new n.MainAreaWidget({content:t});return s.title.label="CellScope Graph",s.title.closable=!0,this.app.shell.add(s,"main"),this.app.shell.activateById(s.id),!0}_buildHeader(){const e=document.createElement("div");e.className="jp-CellScopePanel-header";const t=document.createElement("h3");t.textContent="CellScope Analyzer",e.appendChild(t);const s=document.createElement("div");s.className="jp-CellScopePanel-row";const n=document.createElement("span");n.textContent="Notebook: ",s.appendChild(n),this._pathNode=document.createElement("code"),this._pathNode.textContent="(no notebook)",s.appendChild(this._pathNode),e.appendChild(s);const a=document.createElement("div");return a.className="jp-CellScopePanel-controls",this._analyzeBtn=document.createElement("button"),this._analyzeBtn.textContent="Analyze",this._analyzeBtn.className="jp-mod-styled",this._analyzeBtn.addEventListener("click",()=>{this._analyze()}),this._exportBtn=document.createElement("button"),this._exportBtn.textContent="Export Crate",this._exportBtn.className="jp-mod-styled",this._exportBtn.addEventListener("click",()=>{this._export()}),this._graphBtn=document.createElement("button"),this._graphBtn.textContent="Open Graph",this._graphBtn.className="jp-mod-styled",this._graphBtn.disabled=!0,this._graphBtn.addEventListener("click",()=>{this.openGraphView()||this._setStatus("Export a crate before opening the graph viewer.","warn")}),a.appendChild(this._analyzeBtn),a.appendChild(this._exportBtn),a.appendChild(this._graphBtn),e.appendChild(a),e}async _analyze(){const e=this._currentNotebookPath();if(e){this._setBusy(!0,"Analyzing notebook…");try{const t=await this._requestAnalysis(e);this._renderAnalysis(t),this._setStatus("Analysis complete.","info")}catch(e){console.error(e),this._setStatus(`Failed to analyze notebook: ${this._stringifyError(e)}`,"error")}finally{this._setBusy(!1)}}else this._setStatus("Open a notebook to analyze.","warn")}async _export(){const e=this._currentNotebookPath();if(e){this._setBusy(!0,"Preparing review…");try{const t=await this._requestAnalysis(e);this._renderAnalysis(t),this._setBusy(!1);const s=await this._showReviewDialog(t.graph);if(!s)return void this._setStatus("Export cancelled.","warn");this._setBusy(!0,"Exporting RO-Crate…");const n=`out-lab/${Date.now()}`,a=i.URLExt.join(this._settings.baseUrl,"cellscope","export"),o=await l.ServerConnection.makeRequest(a,{method:"POST",body:JSON.stringify({notebook:e,out_dir:n,hints:s.hints}),headers:{"Content-Type":"application/json"}},this._settings);if(!o.ok)throw new l.ServerConnection.ResponseError(o);const r=(await o.json()).crate;this._latestGraphUrl=this._buildGraphUrl(r),this._exportNode.textContent=`Crate written to ${r}`,this._lastReview=s,this._graphBtn.disabled=!this._latestGraphUrl,this._setStatus("Export complete.","info")}catch(e){console.error(e),this._setStatus(`Failed to export crate: ${this._stringifyError(e)}`,"error")}finally{this._setBusy(!1)}}else this._setStatus("Open a notebook to export.","warn")}_renderAnalysis(e){this._lastAnalysis=e.graph,this._syncFilterOptions(e.graph),this._renderFilterControls(),this._renderFilteredView()}_syncFilterOptions(e){const t=new Set(e.cells.map(e=>e.kernel));this._kernelOptions=Array.from(t).sort((e,t)=>e.localeCompare(t));const s=new Set;this._filterState.kernels.forEach(e=>{t.has(e)&&s.add(e)}),this._filterState.kernels=s;const n=new Set;e.edges.forEach(e=>{e.via&&n.add(String(e.via))}),0===n.size&&n.add("ast"),this._edgeViaOptions=Array.from(n).sort((e,t)=>e.localeCompare(t));const a=new Set;this._filterState.edgeVia.forEach(e=>{n.has(e)&&a.add(e)}),this._filterState.edgeVia=a}_renderFilterControls(){const e=this._lastAnalysis;if(this._filterNode.innerHTML="",!e)return void(this._filterNode.style.display="none");this._filterNode.style.display="";const t=document.createElement("div");t.className="jp-CellScopeFilters-search";const s=document.createElement("label");s.textContent="Search";const n=document.createElement("input");if(n.type="search",n.placeholder="Search cells, files, variables…",n.value=this._filterState.search,n.addEventListener("input",()=>{this._filterState.search=n.value,this._renderFilteredView()}),t.append(s,n),this._filterNode.appendChild(t),this._kernelOptions.length>1){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="Kernel",e.appendChild(t),this._kernelOptions.forEach(t=>{const s=document.createElement("label"),n=document.createElement("input");n.type="checkbox";const a=0===this._filterState.kernels.size;n.checked=a||this._filterState.kernels.has(t),n.addEventListener("change",()=>{const e=new Set(this._filterState.kernels);n.checked?e.add(t):e.delete(t),e.size!==this._kernelOptions.length&&0!==e.size||e.clear(),this._filterState.kernels=e,this._renderFilteredView()}),s.append(n,document.createTextNode(t)),e.appendChild(s)}),this._filterNode.appendChild(e)}const a=document.createElement("div");if(a.className="jp-CellScopeFilters-toggleGroup",a.appendChild(this._createToggle("Only cells that write files",this._filterState.requireFileWrites,e=>{this._filterState.requireFileWrites=e,this._renderFilteredView()})),a.appendChild(this._createToggle("Only cells that read files",this._filterState.requireFileReads,e=>{this._filterState.requireFileReads=e,this._renderFilteredView()})),a.appendChild(this._createToggle("Only SoS exchanges",this._filterState.requireSos,e=>{this._filterState.requireSos=e,this._renderFilteredView()})),this._filterNode.appendChild(a),this._edgeViaOptions.length>1){const e=document.createElement("fieldset");e.className="jp-CellScopeFilters-group";const t=document.createElement("legend");t.textContent="Edge via",e.appendChild(t),this._edgeViaOptions.forEach(t=>{const s=document.createElement("label"),n=document.createElement("input");n.type="checkbox";const a=0===this._filterState.edgeVia.size;n.checked=a||this._filterState.edgeVia.has(t),n.addEventListener("change",()=>{const e=new Set(this._filterState.edgeVia);n.checked?e.add(t):e.delete(t),e.size!==this._edgeViaOptions.length&&0!==e.size||e.clear(),this._filterState.edgeVia=e,this._renderFilteredView()}),s.append(n,document.createTextNode(t)),e.appendChild(s)}),this._filterNode.appendChild(e)}}_renderFilteredView(){const e=this._lastAnalysis;if(this._resultsNode.innerHTML="",this._edgesNode.innerHTML="",!e)return void(this._resultsNode.textContent="Run Analyze to see notebook metadata.");const t=e.cells.filter(e=>this._matchesCell(e));t.length?t.forEach(e=>{const s=e.sos_put??[],n=e.sos_get??[],a=document.createElement("details");a.className="jp-CellScopePanel-cell",a.open=t.length<=4;const i=document.createElement("summary");i.textContent=`Cell ${e.idx} (${e.kernel})`,a.appendChild(i);const l=document.createElement("div");l.className="jp-CellScopePanel-quickActions";const o=document.createElement("button");o.textContent="Activate cell",o.className="jp-mod-styled",o.disabled=!this.tracker||!this.tracker.currentWidget,o.addEventListener("click",()=>{this._activateCell(e.idx)}),l.appendChild(o),a.appendChild(l);const r=document.createElement("div");r.className="jp-CellScopePanel-cellBody",r.append(this._renderList("Functions",e.funcs),this._renderList("Defined Vars",e.var_defs),this._renderList("Used Vars",e.var_uses),this._renderList("File Writes",e.file_writes),this._renderList("File Reads",e.file_reads),this._renderList("SoS put",s),this._renderList("SoS get",n)),a.appendChild(r),this._resultsNode.appendChild(a)}):this._resultsNode.textContent="No cells match the current filters.";const s=document.createElement("h4");s.textContent="Edges",this._edgesNode.appendChild(s);const n=e.edges.filter(e=>this._matchesEdge(e));if(n.length){const e=document.createElement("ul");n.forEach(t=>{const s=[];void 0!==t.source&&void 0!==t.target&&s.push(`Cell ${t.source} → Cell ${t.target}`),t.type&&s.push(`type: ${t.type}`),t.vars?.length&&s.push(`vars: ${t.vars.join(", ")}`);const n=t.via??"ast";s.push(`via ${n}`);const a=document.createElement("li");a.textContent=s.join(" | "),e.appendChild(a)}),this._edgesNode.appendChild(e)}else{const e=document.createElement("p");e.textContent="No edges match the current filters.",this._edgesNode.appendChild(e)}}_matchesCell(e){const{search:t,kernels:s,requireFileReads:n,requireFileWrites:a,requireSos:i}=this._filterState,l=e.sos_put??[],o=e.sos_get??[];if(s.size&&!s.has(e.kernel))return!1;if(a&&0===e.file_writes.length)return!1;if(n&&0===e.file_reads.length)return!1;if(i&&0===l.length&&0===o.length)return!1;const r=t.trim().toLowerCase();if(!r)return!0;const c=this._hintTokensForCell(e);return[`cell ${e.idx}`,e.kernel,...e.funcs,...e.var_defs,...e.var_uses,...e.file_writes,...e.file_reads,...l,...o,...c].join(" ").toLowerCase().includes(r)}_matchesEdge(e){const{edgeVia:t,search:s}=this._filterState,n=(e.via??"ast").toString();if(t.size&&!t.has(n))return!1;const a=s.trim().toLowerCase();if(!a)return!0;const i=[];return void 0!==e.source&&void 0!==e.target&&(i.push(`cell ${e.source}`),i.push(`cell ${e.target}`)),e.type&&i.push(e.type),i.push(n),e.vars?.length&&i.push(...e.vars),i.join(" ").toLowerCase().includes(a)}_createToggle(e,t,s){const n=document.createElement("label");n.className="jp-CellScopeFilters-toggle";const a=document.createElement("input");return a.type="checkbox",a.checked=t,a.addEventListener("change",()=>{s(a.checked)}),n.append(a,document.createTextNode(e)),n}_activateCell(e){const t=this.tracker?.currentWidget;if(!t)return void this._setStatus("Open a notebook to activate cells.","warn");const{content:s}=t;if(!s)return;let n=-1,a=-1;const i=s.widgets.length;for(let t=0;t<i;t++){const i=s.widgets[t];if("code"===i?.model?.type&&(n+=1,n===e)){a=t;break}}-1!==a?(s.activeCellIndex=a,s.deselectAll(),s.scrollToItem(a),this.app.shell.activateById(t.id)):this._setStatus(`Could not locate code cell ${e}.`,"warn")}_hintTokensForCell(e){const t=this._lastReview?.hints;if(!t)return[];const s=[],n=t.roles??{},a=t.domains??{},i=new Set;[...e.var_defs,...e.var_uses].forEach(e=>{const t=n[e];t&&!i.has(t)&&(s.push(t),i.add(t))});const l=e=>{if(Array.isArray(e))e.forEach(e=>{const t=String(e);i.has(t)||(s.push(t),i.add(t))});else{const t=String(e);i.has(t)||(s.push(t),i.add(t))}};return[...e.file_writes,...e.file_reads].forEach(e=>{const t=h(e),s=a[t];s&&Object.values(s).forEach(l)}),s}_renderList(e,t){const s=document.createElement("div");s.className="jp-CellScopePanel-section";const n=document.createElement("strong");return n.textContent=`${e}: `,s.appendChild(n),s.appendChild(document.createTextNode(t.length?t.join(", "):"—")),s}_buildGraphUrl(e){if(!e)return null;const t=e.replace(/\\/g,"/"),s=`${t.startsWith("/")?t.slice(1):t}/cell_graph.html`;return i.URLExt.join(this._settings.baseUrl,"files",s)}_currentNotebookPath(){const e=this.tracker?.currentWidget;return e?.context.path??null}_syncNotebook(){const e=this._currentNotebookPath();this._pathNode.textContent=e??"(no notebook)",this._latestGraphUrl=null,this._graphBtn&&(this._graphBtn.disabled=!0),this._exportNode.textContent="",this._lastReview=null}_setBusy(e,t){this._analyzeBtn.disabled=e,this._exportBtn.disabled=e,t?this._setStatus(t,"info"):e||(this._statusNode.textContent="")}_setStatus(e,t){this._statusNode.textContent=e,this._statusNode.className=`jp-CellScopePanel-status jp-mod-${t}`}async _requestAnalysis(e){const t=i.URLExt.join(this._settings.baseUrl,"cellscope","analyze"),s=await l.ServerConnection.makeRequest(t,{method:"POST",body:JSON.stringify({notebook:e}),headers:{"Content-Type":"application/json"}},this._settings);if(!s.ok)throw new l.ServerConnection.ResponseError(s);return await s.json()}async _showReviewDialog(e){const t=document.createElement("div");t.className="jp-CellScopeReview";const s=document.createElement("p");s.textContent="Review the captured metadata, adjust roles or file metadata, and confirm to generate the RO-Crate.",t.appendChild(s);const a=this._buildReviewDraft(e),i=this._lastReview?.hints??{roles:{},domains:{}},l=new Map,o=new Map,c=document.createElement("div");c.className="jp-CellScopeReview-section";const d=document.createElement("h4");if(d.textContent="Metadata adjustments",c.appendChild(d),a.variables.length||a.files.length){if(a.variables.length){const e=document.createElement("h5");e.textContent=`Variables (${a.variables.length})`,c.appendChild(e),a.variables.forEach(e=>{const t=document.createElement("label");t.className="jp-CellScopeReview-field";const s=document.createElement("span");s.className="jp-CellScopeReview-fieldLabel",s.textContent="function"===e.kind?`${e.name} (function)`:e.name,t.appendChild(s);const n=document.createElement("input");n.type="text",n.className="jp-CellScopeReview-input jp-mod-styled",n.placeholder="function"===e.kind?"Role (e.g., algorithm, helper)":"Role (e.g., dataset, parameter)";const a=i.roles?.[e.name];a&&(n.value=a),t.appendChild(n),c.appendChild(t),l.set(e.name,n)})}if(a.files.length){const e=document.createElement("h5");e.textContent=`Files (${a.files.length})`,c.appendChild(e),a.files.forEach(e=>{const t=document.createElement("div");t.className="jp-CellScopeReview-fileBlock";const s=document.createElement("div");s.className="jp-CellScopeReview-fieldLabel",s.textContent=e.path,t.appendChild(s);const n=document.createElement("input");n.type="text",n.className="jp-CellScopeReview-input jp-mod-styled",n.placeholder="MIME type (e.g., text/csv)";const a=i.domains?.[e.baseName],l=a?a.encodingFormat:void 0,r=Array.isArray(l)?l[0]??"":l??"";r&&(n.value=r),t.appendChild(n);const d=document.createElement("input");d.type="text",d.className="jp-CellScopeReview-input jp-mod-styled",d.placeholder="Tags (comma separated)";const h=a?a.keywords:void 0,p=Array.isArray(h)?h:"string"==typeof h?[h]:[];p.length&&(d.value=p.join(", ")),t.appendChild(d),c.appendChild(t),o.set(e.baseName,{mime:n,tags:d})})}}else{const e=document.createElement("p");e.textContent="No editable metadata detected for this notebook.",c.appendChild(e)}t.appendChild(c);const h=document.createElement("div");h.className="jp-CellScopeReview-section";const p=document.createElement("h4");p.textContent=`Cells (${e.cells.length})`,h.appendChild(p),e.cells.forEach(t=>{const s=document.createElement("details");s.open=e.cells.length<=3;const n=document.createElement("summary");n.textContent=`Cell ${t.idx} (${t.kernel})`,s.appendChild(n);const a=document.createElement("div");a.append(this._renderList("Functions",t.funcs),this._renderList("Defined vars",t.var_defs),this._renderList("Used vars",t.var_uses),this._renderList("File writes",t.file_writes),this._renderList("File reads",t.file_reads),this._renderList("SoS put",t.sos_put??[]),this._renderList("SoS get",t.sos_get??[])),s.appendChild(a),h.appendChild(s)}),t.appendChild(h);const u=document.createElement("div");u.className="jp-CellScopeReview-section";const m=document.createElement("h4");if(m.textContent=`Edges (${e.edges.length})`,u.appendChild(m),e.edges.length){const t=document.createElement("ul");e.edges.forEach(e=>{const s=document.createElement("li"),n=[];void 0!==e.source&&void 0!==e.target&&n.push(`${e.source} → ${e.target}`),e.type&&n.push(e.type),e.vars?.length&&n.push(`vars: ${e.vars.join(", ")}`),e.via&&n.push(`via ${e.via}`),s.textContent=n.join(" | ")||JSON.stringify(e),t.appendChild(s)}),u.appendChild(t)}else{const e=document.createElement("p");e.textContent="No edges detected.",u.appendChild(e)}t.appendChild(u);const _=document.createElement("div");_.className="jp-CellScopeReview-consent";const g=document.createElement("input");g.type="checkbox",g.id="cellscope-review-consent";const C=document.createElement("label");C.htmlFor=g.id,C.textContent="I have reviewed the metadata and want to export the crate.",_.append(g,C),t.appendChild(_);const f=new n.Dialog({title:"Review Notebook Metadata",body:new r.Widget({node:t}),buttons:[n.Dialog.cancelButton({label:"Cancel"}),n.Dialog.okButton({label:"Confirm Export"})]}),v=f.node.querySelector("button.jp-mod-accept");if(v&&(v.disabled=!0,g.addEventListener("change",()=>{v.disabled=!g.checked})),!(await f.launch()).button.accept)return null;const y={};l.forEach((e,t)=>{const s=e.value.trim();s&&(y[t]=s)});const E={};o.forEach((e,t)=>{const s={},n=e.mime.value.trim();n&&(s.encodingFormat=n);const a=e.tags.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);1===a.length?s.keywords=a[0]:a.length>1&&(s.keywords=a),Object.keys(s).length>0&&(E[t]=s)});const S={hints:{roles:y,domains:E}};return this._lastReview=S,S}_buildReviewDraft(e){const t=new Set;e.cells.forEach(e=>{e.funcs.forEach(e=>t.add(e))});const s=new Map;e.cells.forEach(e=>{e.var_defs.forEach(e=>{s.has(e)||s.set(e,{name:e,kind:t.has(e)?"function":"data"})})});const n=new Map;return e.cells.forEach(e=>{[...e.file_writes,...e.file_reads].forEach(e=>{const t=h(e);n.has(t)||n.set(t,{path:e,baseName:t})})}),{variables:Array.from(s.values()).sort((e,t)=>e.name.localeCompare(t.name)),files:Array.from(n.values()).sort((e,t)=>e.baseName.localeCompare(t.baseName))}}_stringifyError(e){if(e instanceof Error)return e.message;if(o.JSONExt.isPrimitive(e))return String(e);try{return JSON.stringify(e)}catch{return"Unknown error"}}}const u={id:"cellscope-lab:plugin",autoStart:!0,optional:[n.ICommandPalette,a.INotebookTracker],activate:(e,t,s)=>{const n=new p(e,s??null);e.shell.add(n,"left",{rank:950}),e.commands.addCommand(c,{label:"CellScope: Show Analyzer",execute:()=>{e.shell.activateById(n.id)}}),e.commands.addCommand(d,{label:"CellScope: Open Graph Panel",execute:()=>{n.openGraphView()||e.commands.execute("apputils:notify",{title:"CellScope",message:"Export a crate before opening the graph viewer.",options:{autoClose:!0}})}}),t&&(t.addItem({command:c,category:"CellScope"}),t.addItem({command:d,category:"CellScope"}))}}}}]);