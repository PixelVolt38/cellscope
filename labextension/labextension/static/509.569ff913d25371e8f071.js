"use strict";(self.webpackChunkcellscope_lab=self.webpackChunkcellscope_lab||[]).push([[509],{509:(e,t,n)=>{n.r(t),n.d(t,{default:()=>p});var s=n(794),o=n(722),a=n(23),i=n(296),l=n(262),r=n(256);const d="cellscope:open-list",c="cellscope:open-graph";class h extends r.Widget{constructor(e,t){super(),this.app=e,this.tracker=t,this._statusNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-status",e})(),this._resultsNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-results",e})(),this._edgesNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-edges",e})(),this._exportNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-export",e})(),this._helpNode=(()=>{const e=document.createElement("div");return e.className="jp-CellScopePanel-help",e.innerHTML="Need the graph? Export a crate, then run <code>CellScope: Open Graph Panel</code>.",e})(),this._latestGraphUrl=null,this.id="cellscope-analysis-panel",this.title.label="CellScope",this.title.closable=!0,this.addClass("jp-CellScopePanel"),this._settings=this.app.serviceManager.serverSettings,this.node.appendChild(this._buildHeader()),this.node.appendChild(this._statusNode),this.node.appendChild(this._resultsNode),this.node.appendChild(this._edgesNode),this.node.appendChild(this._exportNode),this.node.appendChild(this._helpNode),this.tracker&&(this.tracker.currentChanged.connect(this._syncNotebook,this),this.tracker.widgetAdded.connect(this._syncNotebook,this)),this._syncNotebook()}dispose(){this.tracker&&(this.tracker.currentChanged.disconnect(this._syncNotebook,this),this.tracker.widgetAdded.disconnect(this._syncNotebook,this)),super.dispose()}openGraphView(){if(!this._latestGraphUrl)return this._setStatus("Run an export before opening the graph viewer.","warn"),!1;const e=document.createElement("iframe");e.src=this._latestGraphUrl,e.style.width="100%",e.style.height="100%",e.style.border="none";const t=new r.Widget({node:document.createElement("div")});t.node.style.height="100%",t.node.appendChild(e);const n=new s.MainAreaWidget({content:t});return n.title.label="CellScope Graph",n.title.closable=!0,this.app.shell.add(n,"main"),this.app.shell.activateById(n.id),!0}_buildHeader(){const e=document.createElement("div");e.className="jp-CellScopePanel-header";const t=document.createElement("h3");t.textContent="CellScope Analyzer",e.appendChild(t);const n=document.createElement("div");n.className="jp-CellScopePanel-row";const s=document.createElement("span");s.textContent="Notebook: ",n.appendChild(s),this._pathNode=document.createElement("code"),this._pathNode.textContent="(no notebook)",n.appendChild(this._pathNode),e.appendChild(n);const o=document.createElement("div");return o.className="jp-CellScopePanel-controls",this._analyzeBtn=document.createElement("button"),this._analyzeBtn.textContent="Analyze",this._analyzeBtn.className="jp-mod-styled",this._analyzeBtn.addEventListener("click",()=>{this._analyze()}),this._exportBtn=document.createElement("button"),this._exportBtn.textContent="Export Crate",this._exportBtn.className="jp-mod-styled",this._exportBtn.addEventListener("click",()=>{this._export()}),o.appendChild(this._analyzeBtn),o.appendChild(this._exportBtn),e.appendChild(o),e}async _analyze(){const e=this._currentNotebookPath();if(e){this._setBusy(!0,"Analyzing notebook…");try{const t=a.URLExt.join(this._settings.baseUrl,"cellscope","analyze"),n=await i.ServerConnection.makeRequest(t,{method:"POST",body:JSON.stringify({notebook:e}),headers:{"Content-Type":"application/json"}},this._settings);if(!n.ok)throw new i.ServerConnection.ResponseError(n);const s=await n.json();this._renderAnalysis(s),this._setStatus("Analysis complete.","info")}catch(e){console.error(e),this._setStatus(`Failed to analyze notebook: ${this._stringifyError(e)}`,"error")}finally{this._setBusy(!1)}}else this._setStatus("Open a notebook to analyze.","warn")}async _export(){const e=this._currentNotebookPath();if(!e)return void this._setStatus("Open a notebook to export.","warn");const t=`out-lab/${Date.now()}`;this._setBusy(!0,"Exporting RO-Crate…");try{const n=a.URLExt.join(this._settings.baseUrl,"cellscope","export"),s=await i.ServerConnection.makeRequest(n,{method:"POST",body:JSON.stringify({notebook:e,out_dir:t}),headers:{"Content-Type":"application/json"}},this._settings);if(!s.ok)throw new i.ServerConnection.ResponseError(s);const o=(await s.json()).crate;this._latestGraphUrl=this._buildGraphUrl(o),this._exportNode.textContent=`Crate written to ${o}`,this._setStatus("Export complete.","info")}catch(e){console.error(e),this._setStatus(`Failed to export crate: ${this._stringifyError(e)}`,"error")}finally{this._setBusy(!1)}}_renderAnalysis(e){const{cells:t,edges:n}=e.graph;this._resultsNode.innerHTML="",t.length?t.forEach(e=>{const t=document.createElement("details");t.className="jp-CellScopePanel-cell";const n=document.createElement("summary");n.textContent=`Cell ${e.idx} (${e.kernel})`,t.appendChild(n);const s=document.createElement("div");s.className="jp-CellScopePanel-cellBody",s.appendChild(this._renderList("Functions",e.funcs)),s.appendChild(this._renderList("Defined Vars",e.var_defs)),s.appendChild(this._renderList("Used Vars",e.var_uses)),s.appendChild(this._renderList("File Writes",e.file_writes)),s.appendChild(this._renderList("File Reads",e.file_reads)),t.appendChild(s),this._resultsNode.appendChild(t)}):this._resultsNode.textContent="No cells detected.",this._edgesNode.innerHTML="";const s=document.createElement("h4");if(s.textContent="Edges",this._edgesNode.appendChild(s),n.length){const e=document.createElement("ul");n.forEach(t=>{const n=[`type: ${t.type}`];t.vars?.length&&n.push(`vars: ${t.vars.join(", ")}`),t.via&&n.push(`via ${t.via}`);const s=document.createElement("li");s.textContent=n.join(" | "),e.appendChild(s)}),this._edgesNode.appendChild(e)}else{const e=document.createElement("p");e.textContent="No edges detected.",this._edgesNode.appendChild(e)}}_renderList(e,t){const n=document.createElement("div");n.className="jp-CellScopePanel-section";const s=document.createElement("strong");return s.textContent=`${e}: `,n.appendChild(s),n.appendChild(document.createTextNode(t.length?t.join(", "):"—")),n}_buildGraphUrl(e){if(!e)return null;const t=e.replace(/\\/g,"/"),n=`${t.startsWith("/")?t.slice(1):t}/cell_graph.html`;return a.URLExt.join(this._settings.baseUrl,"files",n)}_currentNotebookPath(){const e=this.tracker?.currentWidget;return e?.context.path??null}_syncNotebook(){const e=this._currentNotebookPath();this._pathNode.textContent=e??"(no notebook)",this._latestGraphUrl=null,this._exportNode.textContent=""}_setBusy(e,t){this._analyzeBtn.disabled=e,this._exportBtn.disabled=e,t?this._setStatus(t,"info"):e||(this._statusNode.textContent="")}_setStatus(e,t){this._statusNode.textContent=e,this._statusNode.className=`jp-CellScopePanel-status jp-mod-${t}`}_stringifyError(e){if(e instanceof Error)return e.message;if(l.JSONExt.isPrimitive(e))return String(e);try{return JSON.stringify(e)}catch{return"Unknown error"}}}const p={id:"cellscope-lab:plugin",autoStart:!0,optional:[s.ICommandPalette,o.INotebookTracker],activate:(e,t,n)=>{const s=new h(e,n??null);e.shell.add(s,"left",{rank:950}),e.commands.addCommand(d,{label:"CellScope: Show Analyzer",execute:()=>{e.shell.activateById(s.id)}}),e.commands.addCommand(c,{label:"CellScope: Open Graph Panel",execute:()=>{s.openGraphView()||e.commands.execute("apputils:notify",{title:"CellScope",message:"Export a crate before opening the graph viewer.",options:{autoClose:!0}})}}),t&&(t.addItem({command:d,category:"CellScope"}),t.addItem({command:c,category:"CellScope"}))}}}}]);